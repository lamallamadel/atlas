#!/bin/bash

# Development Stack Management Script
# Usage: ./dev <command> [options]

set -e

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Project directories
BACKEND_DIR="backend"
FRONTEND_DIR="frontend"
INFRA_DIR="infra"

# PID files
BACKEND_PID=".backend.pid"
FRONTEND_PID=".frontend.pid"

# Function to print colored output
print_info() {
    echo -e "${CYAN}$1${NC}"
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

# Function to check if Java is installed
check_java() {
    if [ -z "$JAVA_HOME" ]; then
        print_error "ERROR: JAVA_HOME is not set"
        print_warning "Set JAVA_HOME before running this script:"
        echo "  export JAVA_HOME=/path/to/jdk-17"
        exit 1
    fi
    print_success "✓ JAVA_HOME is set to: $JAVA_HOME"
}

# Function to check if a service is running
check_service() {
    local url=$1
    local name=$2
    if curl -s "$url" > /dev/null 2>&1; then
        print_success "  ✓ $name is running"
        return 0
    else
        print_error "  ✗ $name is not running"
        return 1
    fi
}

# Function to start infrastructure
start_infra() {
    print_info "Starting infrastructure..."
    cd "$INFRA_DIR"
    docker-compose up -d
    cd ..
    print_success "✓ Infrastructure started"
}

# Function to start backend
start_backend() {
    print_info "Building and starting backend..."
    cd "$BACKEND_DIR"
    mvn clean install -DskipTests > /dev/null 2>&1
    nohup mvn spring-boot:run > backend.log 2>&1 &
    echo $! > "../$BACKEND_PID"
    cd ..
    print_success "✓ Backend started (PID: $(cat $BACKEND_PID))"
}

# Function to start frontend
start_frontend() {
    print_info "Installing frontend dependencies and starting..."
    cd "$FRONTEND_DIR"
    npm install > /dev/null 2>&1
    nohup npm start > frontend.log 2>&1 &
    echo $! > "../$FRONTEND_PID"
    cd ..
    print_success "✓ Frontend started (PID: $(cat $FRONTEND_PID))"
}

# Function to stop services
stop_services() {
    print_warning "Stopping development stack..."
    
    # Stop backend
    if [ -f "$BACKEND_PID" ]; then
        kill $(cat "$BACKEND_PID") 2>/dev/null || true
        rm "$BACKEND_PID"
    fi
    pkill -f "spring-boot:run" 2>/dev/null || true
    
    # Stop frontend
    if [ -f "$FRONTEND_PID" ]; then
        kill $(cat "$FRONTEND_PID") 2>/dev/null || true
        rm "$FRONTEND_PID"
    fi
    pkill -f "ng serve" 2>/dev/null || true
    
    # Stop infrastructure
    cd "$INFRA_DIR"
    docker-compose down
    cd ..
    
    print_success "✓ Stack stopped"
}

# Function to show status
show_status() {
    print_info "Service Status:"
    echo ""
    
    print_info "Infrastructure:"
    cd "$INFRA_DIR"
    docker-compose ps
    cd ..
    echo ""
    
    print_info "Backend (Spring Boot):"
    check_service "http://localhost:8080/actuator/health" "Backend"
    echo ""
    
    print_info "Frontend (Angular):"
    check_service "http://localhost:4200" "Frontend"
}

# Function to show logs
show_logs() {
    local service=$1
    case $service in
        backend)
            print_info "Backend logs:"
            if [ -f "$BACKEND_DIR/backend.log" ]; then
                tail -f "$BACKEND_DIR/backend.log"
            else
                print_warning "Backend log file not found"
            fi
            ;;
        frontend)
            print_info "Frontend logs:"
            if [ -f "$FRONTEND_DIR/frontend.log" ]; then
                tail -f "$FRONTEND_DIR/frontend.log"
            else
                print_warning "Frontend log file not found"
            fi
            ;;
        db)
            print_info "Database logs:"
            cd "$INFRA_DIR"
            docker-compose logs -f postgres
            cd ..
            ;;
        *)
            print_info "All infrastructure logs:"
            cd "$INFRA_DIR"
            docker-compose logs -f
            cd ..
            ;;
    esac
}

# Function to reset database
reset_db() {
    print_warning "Resetting database..."
    cd "$INFRA_DIR"
    docker-compose down
    docker volume rm postgres_data 2>/dev/null || print_warning "Volume not found, continuing..."
    docker-compose up -d
    cd ..
    print_success "✓ Database reset complete"
}

# Function to show help
show_help() {
    cat << EOF
${CYAN}Development Stack Management${NC}

${GREEN}Usage:${NC}
  ./dev <command> [options]

${GREEN}Commands:${NC}
  ${CYAN}up${NC}              Start the full development stack
  ${CYAN}down${NC}            Stop all services
  ${CYAN}restart${NC}         Restart all services
  ${CYAN}status${NC}          Check status of all services
  ${CYAN}logs${NC} [service]  View logs (all, backend, frontend, db)
  ${CYAN}reset${NC}           Reset database (delete all data)
  ${CYAN}help${NC}            Show this help message

${GREEN}Examples:${NC}
  ./dev up              # Start everything
  ./dev down            # Stop everything
  ./dev logs            # View all infrastructure logs
  ./dev logs backend    # View backend logs
  ./dev logs frontend   # View frontend logs
  ./dev logs db         # View database logs
  ./dev reset           # Reset database

${YELLOW}Prerequisites:${NC}
  - Java 17 (JAVA_HOME must be set)
  - Maven 3.6+
  - Node.js 18+ and npm
  - Docker & Docker Compose

${CYAN}Access:${NC}
  Frontend:  http://localhost:4200
  Backend:   http://localhost:8080
  API Docs:  http://localhost:8080/swagger-ui.html
  Health:    http://localhost:8080/actuator/health

EOF
}

# Main command handler
case "${1:-help}" in
    up)
        check_java
        print_info "Starting development stack..."
        echo ""
        start_infra
        sleep 3
        start_backend
        sleep 2
        start_frontend
        echo ""
        print_success "✓ Stack started!"
        echo ""
        print_info "Access:"
        echo "  Frontend:  http://localhost:4200"
        echo "  Backend:   http://localhost:8080"
        echo "  API Docs:  http://localhost:8080/swagger-ui.html"
        echo "  Health:    http://localhost:8080/actuator/health"
        echo ""
        print_warning "Note: Services may take a few moments to be fully ready"
        ;;
    down)
        stop_services
        ;;
    restart)
        stop_services
        sleep 2
        check_java
        print_info "Starting development stack..."
        start_infra
        sleep 3
        start_backend
        sleep 2
        start_frontend
        print_success "✓ Stack restarted!"
        ;;
    status)
        show_status
        ;;
    logs)
        show_logs "${2:-all}"
        ;;
    reset)
        reset_db
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
