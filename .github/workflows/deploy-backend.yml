name: Deploy Backend

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'
      - 'infra/docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

concurrency:
  group: deploy-backend
  cancel-in-progress: true

jobs:
  deploy:
    name: Build & Deploy backend_app
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: ssh-keyscan -H 46.225.187.158 >> ~/.ssh/known_hosts

      - name: Pull, build and restart backend
        run: |
          ssh lamal@46.225.187.158 "
            set -e
            cd /opt/atlas
            git pull origin master --quiet
            cd infra
            docker compose build backend
            docker compose up -d backend
            echo '✓ Backend container started, waiting for health check...'
          "

      - name: Wait for backend to be healthy
        run: |
          ssh lamal@46.225.187.158 "
            for i in \$(seq 1 24); do
              STATUS=\$(docker inspect --format='{{.State.Health.Status}}' backend_app 2>/dev/null)
              echo \"  [\$i/24] backend_app: \$STATUS\"
              if [ \"\$STATUS\" = 'healthy' ]; then
                echo '✓ Backend is healthy'
                exit 0
              fi
              sleep 5
            done
            echo '✗ Backend did not become healthy within 2 minutes'
            docker logs backend_app --tail=30
            exit 1
          "
