name: Backend E2E Tests

on:
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/backend-e2e-tests.yml'
  push:
    branches:
      - master
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-h2:
    name: E2E Tests (H2)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run E2E tests with H2
        run: mvn -B -ntp verify -Pbackend-e2e-h2 -Dtest.database=h2
        working-directory: backend
        env:
          MAVEN_OPTS: -Xmx1024m
      
      - name: Generate test report
        if: always() && github.event.pull_request.head.repo.fork == false
        uses: dorny/test-reporter@v1
        with:
          name: E2E Test Results (H2)
          path: |
            backend/target/surefire-reports/*.xml
            backend/target/failsafe-reports/*.xml
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-h2
          path: |
            backend/target/surefire-reports/
            backend/target/failsafe-reports/
          retention-days: 7
      
      - name: Generate coverage report
        run: mvn -B -ntp jacoco:report
        working-directory: backend
        if: always() && github.event_name != 'pull_request'
      
      - name: Upload coverage report
        if: always() && github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-h2
          path: backend/target/site/jacoco/
          retention-days: 7
      
      - name: Check coverage thresholds
        run: mvn -B -ntp jacoco:check
        working-directory: backend
        if: always() && github.event_name != 'pull_request'
      
      - name: Add PR comment with test results
        if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## üß™ E2E Test Results (H2)\n\n';
            
            try {
              const surefireDir = 'backend/target/surefire-reports';
              if (fs.existsSync(surefireDir)) {
                const files = fs.readdirSync(surefireDir).filter(f => f.endsWith('.xml'));
                let totalTests = 0;
                let totalFailures = 0;
                let totalErrors = 0;
                let totalSkipped = 0;
                
                files.forEach(file => {
                  const content = fs.readFileSync(path.join(surefireDir, file), 'utf8');
                  const testsMatch = content.match(/tests="(\d+)"/);
                  const failuresMatch = content.match(/failures="(\d+)"/);
                  const errorsMatch = content.match(/errors="(\d+)"/);
                  const skippedMatch = content.match(/skipped="(\d+)"/);
                  
                  if (testsMatch) totalTests += parseInt(testsMatch[1]);
                  if (failuresMatch) totalFailures += parseInt(failuresMatch[1]);
                  if (errorsMatch) totalErrors += parseInt(errorsMatch[1]);
                  if (skippedMatch) totalSkipped += parseInt(skippedMatch[1]);
                });
                
                const passed = totalTests - totalFailures - totalErrors - totalSkipped;
                const status = (totalFailures + totalErrors) === 0 ? '‚úÖ' : '‚ùå';
                
                comment += `${status} **Total:** ${totalTests} tests\n`;
                comment += `- ‚úÖ Passed: ${passed}\n`;
                comment += `- ‚ùå Failed: ${totalFailures}\n`;
                comment += `- ‚ö†Ô∏è Errors: ${totalErrors}\n`;
                comment += `- ‚è≠Ô∏è Skipped: ${totalSkipped}\n`;
              } else {
                comment += '‚ö†Ô∏è No test results found\n';
              }
            } catch (error) {
              comment += `‚ö†Ô∏è Error reading test results: ${error.message}\n`;
            }
            
            comment += '\nüìä Full test report available in the test-reporter output above.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  backend-postgres:
    name: E2E Tests (PostgreSQL)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run E2E tests with PostgreSQL (Testcontainers)
        run: mvn -B -ntp verify -Pbackend-e2e-postgres -Dtest.database=postgres
        working-directory: backend
        env:
          MAVEN_OPTS: -Xmx2048m
      
      - name: Generate test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: E2E Test Results (PostgreSQL)
          path: |
            backend/target/surefire-reports/*.xml
            backend/target/failsafe-reports/*.xml
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-postgres
          path: |
            backend/target/surefire-reports/
            backend/target/failsafe-reports/
          retention-days: 7
      
      - name: Generate coverage report
        run: mvn -B -ntp jacoco:report
        working-directory: backend
        if: always()
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-postgres
          path: backend/target/site/jacoco/
          retention-days: 7
