name: Frontend E2E Tests

on:
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/frontend-e2e-tests.yml'
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'  # Nightly at 3 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  playwright-h2-mock:
    name: Playwright (H2 + Mock Auth)
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Cache Angular build artifacts
        uses: actions/cache@v4
        with:
          path: frontend/.angular/cache
          key: ${{ runner.os }}-angular-cache-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-angular-cache-
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: frontend
        env:
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Build backend
        run: ../mvnw clean package -DskipTests
        working-directory: backend
      
      - name: Start backend (H2 + Mock)
        run: |
          set -euo pipefail
          APP_JAR="$(ls -1 target/*.jar | head -n 1)"
          if [ -z "$APP_JAR" ]; then
            echo "No backend JAR found in target/." >&2
            exit 1
          fi
          nohup java -jar "$APP_JAR" --spring.profiles.active=e2e-h2-mock --server.port=8080 --spring.main.allow-bean-definition-overriding=true > backend.log 2>&1 &
          echo $! > backend.pid
        working-directory: backend
      
      - name: Wait for backend health
        run: |
          timeout 120 bash -c 'until curl -fsS http://localhost:8080/actuator/health; do sleep 2; done'
      - name: Show backend log on failure
        if: failure()
        run: cat backend.log || true
        working-directory: backend
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Start frontend
        run: |
          set -euo pipefail
          nohup npm run start -- --host 0.0.0.0 --port 4200 > frontend.log 2>&1 &
          echo $! > frontend.pid
        working-directory: frontend

      - name: Wait for frontend
        run: |
          timeout 120 bash -c 'until curl -fsS http://localhost:4200; do sleep 2; done'
      
      - name: Show frontend log on failure
        if: failure()
        run: cat frontend.log || true
        working-directory: frontend
      
      - name: Run Playwright tests
        run: npx playwright test --config=playwright.config.ts
        working-directory: frontend
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4200
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-h2-mock
          path: frontend/playwright-report/
          retention-days: 7
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-h2-mock
          path: frontend/test-results/
          retention-days: 7

      - name: Upload Playwright logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-logs-h2-mock
          path: |
            frontend/frontend.log
            backend/backend.log
          retention-days: 7
      
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
        working-directory: backend

      - name: Stop frontend
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi
        working-directory: frontend

  playwright-postgres-mock:
    name: Playwright (PostgreSQL + Mock Auth)
    runs-on: ubuntu-latest
    timeout-minutes: 12
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Cache Angular build artifacts
        uses: actions/cache@v4
        with:
          path: frontend/.angular/cache
          key: ${{ runner.os }}-angular-cache-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-angular-cache-
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: frontend
        env:
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Build backend
        run: ../mvnw clean package -DskipTests
        working-directory: backend
      
      - name: Start PostgreSQL and Backend
        run: |
          docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml up -d postgres backend
          docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml ps
        working-directory: infra
      
      - name: Wait for services health
        run: |
          timeout 120 bash -c 'until docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml ps | grep backend_e2e | grep -q "healthy"; do sleep 3; done'
        working-directory: infra
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Start frontend
        run: |
          set -euo pipefail
          nohup npm run start -- --host 0.0.0.0 --port 4200 > frontend.log 2>&1 &
          echo $! > frontend.pid
        working-directory: frontend

      - name: Wait for frontend
        run: |
          timeout 120 bash -c 'until curl -fsS http://localhost:4200; do sleep 2; done'
      
      - name: Show frontend log on failure
        if: failure()
        run: cat frontend.log || true
        working-directory: frontend
      
      - name: Run Playwright tests (PostgreSQL config)
        run: npx playwright test --config=playwright-postgres-mock.config.ts
        working-directory: frontend
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4200
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-postgres-mock
          path: frontend/playwright-report/
          retention-days: 7
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-postgres-mock
          path: frontend/test-results/
          retention-days: 7

      - name: Upload Playwright logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-logs-postgres-mock
          path: |
            frontend/frontend.log
            backend/backend.log
          retention-days: 7
      
      - name: Show backend logs
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml logs backend
        working-directory: infra
      
      - name: Cleanup services
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml down -v
        working-directory: infra

      - name: Stop frontend
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi
        working-directory: frontend

  playwright-full:
    name: Playwright Full (${{ matrix.variant }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule'
    
    strategy:
      fail-fast: false
      matrix:
        variant:
          - h2-mock
          - h2-keycloak
          - postgres-mock
          - postgres-keycloak
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Cache Angular build artifacts
        uses: actions/cache@v4
        with:
          path: frontend/.angular/cache
          key: ${{ runner.os }}-angular-cache-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-angular-cache-
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: frontend
        env:
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Build backend
        run: ../mvnw clean package -DskipTests
        working-directory: backend
      
      # H2 variants - start backend directly
      - name: Start backend (H2 variants)
        if: startsWith(matrix.variant, 'h2-')
        run: |
          set -euo pipefail
          PROFILE="e2e-${{ matrix.variant }}"
          APP_JAR="$(ls -1 target/*.jar | head -n 1)"
          if [ -z "$APP_JAR" ]; then
            echo "No backend JAR found in target/." >&2
            exit 1
          fi
          nohup java -jar "$APP_JAR" --spring.profiles.active=$PROFILE --server.port=8080 --spring.main.allow-bean-definition-overriding=true > backend.log 2>&1 &
          echo $! > backend.pid
          timeout 120 bash -c 'until curl -fsS http://localhost:8080/actuator/health; do sleep 2; done'
        working-directory: backend
      
      # PostgreSQL + Keycloak variants - use docker-compose
      - name: Start services (Keycloak variants)
        if: contains(matrix.variant, 'keycloak')
        run: |
          if [[ "${{ matrix.variant }}" == "postgres-keycloak" ]]; then
            docker compose -f docker-compose.yml up -d postgres keycloak backend
          elif [[ "${{ matrix.variant }}" == "h2-keycloak" ]]; then
            docker compose -f docker-compose.yml up -d keycloak
          fi
          timeout 180 bash -c 'until curl -f http://localhost:8081/realms/myrealm; do sleep 3; done'
        working-directory: infra
      
      # PostgreSQL mock variant - use e2e postgres compose
      - name: Start services (PostgreSQL mock)
        if: matrix.variant == 'postgres-mock'
        run: |
          docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml up -d postgres backend
          timeout 120 bash -c 'until docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml ps | grep backend_e2e | grep -q "healthy"; do sleep 3; done'
        working-directory: infra
      
      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Start frontend
        run: |
          set -euo pipefail
          nohup npm run start -- --host 0.0.0.0 --port 4200 > frontend.log 2>&1 &
          echo $! > frontend.pid
        working-directory: frontend

      - name: Wait for frontend
        run: |
          timeout 120 bash -c 'until curl -fsS http://localhost:4200; do sleep 2; done'
      
      - name: Show frontend log on failure
        if: failure()
        run: cat frontend.log || true
        working-directory: frontend
      
      # Determine which config file to use
      - name: Run Playwright tests
        run: |
          case "${{ matrix.variant }}" in
            h2-mock)
              CONFIG="playwright.config.ts"
              ;;
            postgres-mock)
              CONFIG="playwright-postgres-mock.config.ts"
              ;;
            h2-keycloak)
              CONFIG="playwright-h2-keycloak.config.ts"
              ;;
            postgres-keycloak)
              CONFIG="playwright-postgres-keycloak.config.ts"
              ;;
          esac
          npx playwright test --config=$CONFIG
        working-directory: frontend
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4200
          PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      
      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.variant }}
          path: frontend/playwright-report/
          retention-days: 14
      
      - name: Upload videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-videos-${{ matrix.variant }}
          path: frontend/test-results/**/video.webm
          retention-days: 14
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-${{ matrix.variant }}
          path: frontend/test-results/
          retention-days: 14

      - name: Upload Playwright logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-logs-${{ matrix.variant }}
          path: |
            frontend/frontend.log
            backend/backend.log
          retention-days: 14
      
      - name: Show backend logs (H2)
        if: failure() && startsWith(matrix.variant, 'h2-')
        run: cat backend.log || true
        working-directory: backend
      
      - name: Show backend logs (Docker)
        if: failure() && !startsWith(matrix.variant, 'h2-')
        run: docker compose -f docker-compose.yml logs backend || true
        working-directory: infra
      
      - name: Stop backend (H2)
        if: always() && startsWith(matrix.variant, 'h2-')
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi
        working-directory: backend
      
      - name: Cleanup services (Docker)
        if: always() && !startsWith(matrix.variant, 'h2-')
        run: |
          if [[ "${{ matrix.variant }}" == "postgres-mock" ]]; then
            docker compose -f docker-compose.yml -f docker-compose.e2e-postgres.yml down -v
          else
            docker compose -f docker-compose.yml down -v
          fi
        working-directory: infra

      - name: Stop frontend
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi
        working-directory: frontend
