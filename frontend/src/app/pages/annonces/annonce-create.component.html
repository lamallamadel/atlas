<div class="page-container">
  <div class="page-header">
    <h2 class="page-title">{{ isEditMode ? 'Modifier l\'annonce' : 'Créer une nouvelle annonce' }}</h2>
  </div>

  <div class="page-content">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement de l'annonce...</p>
    </div>

    <div *ngIf="error && !loading" class="error-alert">
      <span class="error-icon">⚠</span>
      <span>{{ error }}</span>
    </div>

    <mat-stepper *ngIf="!loading" [linear]="true" #stepper class="annonce-stepper">
      <!-- Step 1: Category, AnnonceType, Title, Description -->
      <mat-step [stepControl]="step1FormGroup" label="Informations de base">
        <form [formGroup]="step1FormGroup" class="step-form">
          <h3 class="step-title">Informations de base</h3>

          <!-- Category (APARTMENT/HOUSE/STUDIO/COMMERCIAL) -->
          <div class="form-group">
            <label for="category" class="form-label">
              Catégorie <span class="required">*</span>
            </label>
            <select id="category" class="form-select" formControlName="category"
              [class.invalid]="isFieldInvalid(step1FormGroup, 'category')">
              <option value="">Sélectionner une catégorie</option>
              <option *ngFor="let option of categoryOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <div *ngIf="getFieldError(step1FormGroup, 'category')" class="field-error">
              {{ getFieldError(step1FormGroup, 'category') }}
            </div>
          </div>

          <!-- Annonce Type (SALE/RENT/LEASE/EXCHANGE) -->
          <div class="form-group">
            <label for="annonceType" class="form-label">
              Type d’annonce <span class="required">*</span>
            </label>
            <select id="annonceType" class="form-select" formControlName="annonceType"
              [class.invalid]="isFieldInvalid(step1FormGroup, 'annonceType')">
              <option value="">Sélectionner un type</option>
              <option *ngFor="let option of annonceTypeOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <div *ngIf="getFieldError(step1FormGroup, 'annonceType')" class="field-error">
              {{ getFieldError(step1FormGroup, 'annonceType') }}
            </div>
          </div>

          <div class="form-group">
            <label for="title" class="form-label">
              Titre <span class="required">*</span>
            </label>
            <input id="title" type="text" class="form-input" formControlName="title"
              [class.invalid]="isFieldInvalid(step1FormGroup, 'title')" placeholder="Saisir le titre de l'annonce" />
            <div *ngIf="getFieldError(step1FormGroup, 'title')" class="field-error">
              {{ getFieldError(step1FormGroup, 'title') }}
            </div>
          </div>

          <div class="form-group">
            <label for="description" class="form-label">
              Description
            </label>
            <textarea id="description" class="form-textarea" formControlName="description"
              [class.invalid]="isFieldInvalid(step1FormGroup, 'description')"
              placeholder="Saisir la description de l'annonce" rows="5"></textarea>
            <div *ngIf="getFieldError(step1FormGroup, 'description')" class="field-error">
              {{ getFieldError(step1FormGroup, 'description') }}
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn-cancel" (click)="onCancel()">Annuler</button>
            <button type="button" class="btn-next" matStepperNext>Suivant</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Price, City, Address, Surface -->
      <mat-step [stepControl]="step2FormGroup" label="Localisation et détails">
        <form [formGroup]="step2FormGroup" class="step-form">
          <h3 class="step-title">Localisation et détails</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="price" class="form-label">
                Prix (EUR)
              </label>
              <input id="price" type="number" class="form-input" formControlName="price"
                [class.invalid]="isFieldInvalid(step2FormGroup, 'price')" placeholder="0.00" step="0.01" min="0" />
              <div *ngIf="getFieldError(step2FormGroup, 'price')" class="field-error">
                {{ getFieldError(step2FormGroup, 'price') }}
              </div>
            </div>

            <div class="form-group">
              <label for="surface" class="form-label">
                Surface (m²)
              </label>
              <input id="surface" type="number" class="form-input" formControlName="surface"
                [class.invalid]="isFieldInvalid(step2FormGroup, 'surface')" placeholder="0" step="1" min="0" />
              <div *ngIf="getFieldError(step2FormGroup, 'surface')" class="field-error">
                {{ getFieldError(step2FormGroup, 'surface') }}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="city" class="form-label">
              Ville
            </label>
            <input id="city" type="text" class="form-input" formControlName="city"
              [class.invalid]="isFieldInvalid(step2FormGroup, 'city')" placeholder="Saisir la ville" />
            <div *ngIf="getFieldError(step2FormGroup, 'city')" class="field-error">
              {{ getFieldError(step2FormGroup, 'city') }}
            </div>
          </div>

          <div class="form-group">
            <label for="address" class="form-label">
              Adresse
            </label>
            <input id="address" type="text" class="form-input" formControlName="address"
              [class.invalid]="isFieldInvalid(step2FormGroup, 'address')" placeholder="Saisir l'adresse" />
            <div *ngIf="getFieldError(step2FormGroup, 'address')" class="field-error">
              {{ getFieldError(step2FormGroup, 'address') }}
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn-back" matStepperPrevious>Retour</button>
            <button type="button" class="btn-next" matStepperNext>Suivant</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Photos -->
      <mat-step [stepControl]="step3FormGroup" label="Photos">
        <form [formGroup]="step3FormGroup" class="step-form">
          <h3 class="step-title">Photos</h3>

          <div class="photos-section">
            <!-- Photo List Display -->
            <div *ngIf="photos.length === 0" class="empty-photos">
              <p class="empty-title">Aucune photo ajoutée</p>
              <p class="empty-subtitle">Ajoutez une URL de photo ci-dessous</p>
            </div>

            <div *ngIf="photos.length > 0" class="photos-list">
              <div *ngFor="let photo of photos.controls; let i = index" class="photo-row">
                <div class="photo-thumbnail">
                  <img *ngIf="!photoErrors[i]" [src]="getPhotoControl(i).value" [alt]="'Photo ' + (i + 1)"
                    (error)="onPhotoError(i)" (load)="onPhotoLoad(i)" class="photo-preview" />
                  <div *ngIf="photoErrors[i]" class="photo-error-placeholder">
                    <span>⚠</span>
                  </div>
                </div>
                <div class="photo-url">
                  {{ getPhotoControl(i).value }}
                </div>
                <button type="button" class="btn-delete-photo" (click)="removePhoto(i)" title="Supprimer cette photo">
                  Supprimer
                </button>
              </div>
            </div>

            <!-- Add Photo Input -->
            <div class="add-photo-section">
              <div class="add-photo-input-group">
                <label for="newPhotoUrl" class="form-label">
                  Ajouter une nouvelle photo
                </label>
                <div class="add-photo-wrapper">
                  <input id="newPhotoUrl" type="text" class="form-input" [(ngModel)]="newPhotoUrl"
                    [ngModelOptions]="{standalone: true}" placeholder="Saisir l'URL de la photo"
                    (keyup.enter)="addPhoto()" />
                  <button type="button" class="btn-add-photo" (click)="addPhoto()" [disabled]="!newPhotoUrl.trim()">
                    Ajouter
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn-back" matStepperPrevious>Retour</button>
            <button type="button" class="btn-next" matStepperNext>Suivant</button>
          </div>
        </form>
      </mat-step>

      <!-- Step 4: Rules JSON -->
      <mat-step [stepControl]="step4FormGroup" label="Règles">
        <form [formGroup]="step4FormGroup" class="step-form">
          <h3 class="step-title">Règles JSON</h3>

          <div class="form-group">
            <label for="rulesJson" class="form-label">
              Règles JSON <span class="required">*</span>
            </label>
            <div class="json-editor-controls">
              <button type="button" class="btn-format-json" (click)="formatJson()">
                Formater le JSON
              </button>
            </div>
            <textarea id="rulesJson" class="form-textarea json-editor" formControlName="rulesJson"
              [class.invalid]="isFieldInvalid(step4FormGroup, 'rulesJson')"
              placeholder='Saisir les règles au format JSON, par ex. {"allowPets": true, "smokingAllowed": false}'
              rows="10"></textarea>
            <div *ngIf="getFieldError(step4FormGroup, 'rulesJson')" class="field-error">
              {{ getFieldError(step4FormGroup, 'rulesJson') }}
            </div>
            <div class="json-hint">
              Saisir un format JSON valide. Utilisez le bouton "Formater le JSON" pour auto-formater votre JSON.
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn-back" matStepperPrevious>Retour</button>
            <button type="button" class="btn-submit" (click)="onSubmit()" [disabled]="submitting">
              <span *ngIf="!submitting">{{ isEditMode ? 'Modifier' : 'Créer' }}</span>
              <span *ngIf="submitting" class="btn-loading">
                <span class="btn-spinner"></span>
                {{ isEditMode ? 'Modification...' : 'Création...' }}
              </span>
            </button>
          </div>
        </form>
      </mat-step>
    </mat-stepper>
  </div>
</div>