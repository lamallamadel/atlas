<div class="page-container">
  <header class="page-header">
    <h1 class="page-title">Annonces</h1>
    <button 
      class="btn-create" 
      (click)="createAnnonce()" 
      aria-label="Ouvrir le formulaire pour créer une nouvelle annonce"
      (keydown.enter)="createAnnonce()"
      (keydown.space)="$event.preventDefault(); createAnnonce()">
      <span class="btn-icon" aria-hidden="true">+</span>
      Créer une annonce
    </button>
  </header>

  <!-- Desktop Filters -->
  <section *ngIf="!isMobile" aria-label="Filtres de recherche">
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-container">
          <mat-expansion-panel 
            [(expanded)]="filterPanelExpanded"
            class="filter-panel">
            <mat-expansion-panel-header
              tabindex="0"
              role="button"
              [attr.aria-expanded]="filterPanelExpanded"
              aria-label="Afficher ou masquer les filtres de recherche">
              <mat-panel-title>
                <mat-icon aria-hidden="true">filter_list</mat-icon>
                <span>Filtres</span>
                <span class="filter-count" *ngIf="appliedFilters.length > 0" [attr.aria-label]="appliedFilters.length + ' filtres actifs'">
                  ({{ appliedFilters.length }})
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="filter-content">
              <!-- Filter Fields Grid -->
              <div class="filter-row">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Recherche</mat-label>
                  <input
                    matInput
                    placeholder="Rechercher des annonces"
                    [(ngModel)]="searchQuery"
                    (keyup.enter)="applyFilters()"
                    aria-label="Rechercher des annonces par mots-clés"
                  />
                  <mat-icon matSuffix aria-hidden="true">search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Statut</mat-label>
                  <mat-select [(ngModel)]="selectedStatus" (selectionChange)="applyFilters()" aria-label="Filtrer par statut">
                    <mat-option value="">Tous</mat-option>
                    <mat-option [value]="AnnonceStatus.DRAFT">Brouillon</mat-option>
                    <mat-option [value]="AnnonceStatus.PUBLISHED">Publié</mat-option>
                    <mat-option [value]="AnnonceStatus.ACTIVE">Actif</mat-option>
                    <mat-option [value]="AnnonceStatus.PAUSED">En pause</mat-option>
                    <mat-option [value]="AnnonceStatus.ARCHIVED">Archivé</mat-option>
                  </mat-select>
                  <mat-icon matSuffix aria-hidden="true">filter_alt</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Ville</mat-label>
                  <mat-select [(ngModel)]="selectedCity" (selectionChange)="applyFilters()" aria-label="Filtrer par ville">
                    <mat-option value="">Toutes</mat-option>
                    <mat-option *ngFor="let city of availableCities; trackBy: trackByCity" [value]="city">
                      {{ city }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix aria-hidden="true">filter_alt</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Type/Catégorie</mat-label>
                  <mat-select [(ngModel)]="selectedType" (selectionChange)="applyFilters()" aria-label="Filtrer par type ou catégorie">
                    <mat-option value="">Tous</mat-option>
                    <mat-option *ngFor="let type of availableTypes; trackBy: trackByType" [value]="type">
                      {{ type }}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix aria-hidden="true">filter_alt</mat-icon>
                </mat-form-field>
              </div>

              <!-- Filter Actions -->
              <div class="filter-actions">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="applyFilters()" 
                  aria-label="Appliquer les filtres sélectionnés"
                  (keydown.enter)="applyFilters()"
                  (keydown.space)="$event.preventDefault(); applyFilters()">
                  <mat-icon aria-hidden="true">check</mat-icon>
                  Appliquer
                </button>
                <button 
                  mat-button 
                  (click)="resetFilters()" 
                  aria-label="Réinitialiser tous les filtres"
                  (keydown.enter)="resetFilters()"
                  (keydown.space)="$event.preventDefault(); resetFilters()">
                  <mat-icon aria-hidden="true">clear</mat-icon>
                  Réinitialiser
                </button>
                
                <button 
                  mat-button 
                  [matMenuTriggerFor]="presetMenu" 
                  aria-label="Ouvrir le menu de gestion des presets de filtres" 
                  aria-haspopup="true">
                  <mat-icon aria-hidden="true">bookmark</mat-icon>
                  Presets
                </button>
                <mat-menu #presetMenu="matMenu" aria-label="Menu des presets">
                  <button mat-menu-item (click)="saveCurrentFilters()" aria-label="Sauvegarder les filtres actuels comme preset">
                    <mat-icon aria-hidden="true">save</mat-icon>
                    <span>Sauvegarder les filtres actuels</span>
                  </button>
                  <mat-divider *ngIf="savedPresets.length > 0" role="separator"></mat-divider>
                  <button 
                    mat-menu-item 
                    *ngFor="let preset of savedPresets; trackBy: trackByPreset"
                    (click)="loadPreset(preset)"
                    [attr.aria-label]="'Charger le preset ' + preset.name">
                    <mat-icon aria-hidden="true">folder</mat-icon>
                    <span>{{ preset.name }}</span>
                    <button 
                      mat-icon-button 
                      (click)="deletePreset(preset, $event)"
                      class="delete-preset-btn"
                      [attr.aria-label]="'Supprimer le preset ' + preset.name">
                      <mat-icon aria-hidden="true">delete</mat-icon>
                    </button>
                  </button>
                  <div *ngIf="savedPresets.length === 0" class="empty-presets" role="status">
                    <span class="empty-text">Aucun preset sauvegardé</span>
                  </div>
                </mat-menu>
              </div>

              <!-- Active Filter Chips -->
              <div class="active-filters-row" *ngIf="appliedFilters.length > 0" role="region" aria-label="Filtres actifs">
                <div class="active-filters-header">
                  <span class="filters-label">Filtres actifs :</span>
                  <button mat-button (click)="resetFilters()" class="clear-all-btn" aria-label="Effacer tous les filtres">
                    <mat-icon aria-hidden="true">clear_all</mat-icon>
                    Tout effacer
                  </button>
                </div>
                <mat-chip-set aria-label="Filtres appliqués" [@listStaggerAnimation]="appliedFilters.length">
                  <mat-chip
                    *ngFor="let filter of appliedFilters; trackBy: trackByFilter"
                    (removed)="removeFilter(filter)"
                    [@itemAnimation]
                    [attr.aria-label]="filter.label + ': ' + filter.displayValue">
                    <strong>{{ filter.label }}:</strong> {{ filter.displayValue }}
                    <button matChipRemove [attr.aria-label]="'Retirer le filtre ' + filter.label">
                      <mat-icon aria-hidden="true">cancel</mat-icon>
                    </button>
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <!-- Mobile Filter Button -->
  <div class="mobile-filter-button" *ngIf="isMobile">
    <button mat-raised-button color="primary" (click)="openMobileFilters()" aria-label="Ouvrir les filtres">
      <mat-icon aria-hidden="true">filter_list</mat-icon>
      Filtres
      <span class="filter-badge" *ngIf="appliedFilters.length > 0" [attr.aria-label]="appliedFilters.length + ' filtres actifs'">
        {{ appliedFilters.length }}
      </span>
    </button>
  </div>

  <main class="page-content">
    <app-loading-skeleton *ngIf="loading" variant="table" [rows]="10" [columns]="8" aria-label="Chargement des annonces"></app-loading-skeleton>

    <div *ngIf="error && !loading" class="error-state" role="alert" aria-live="assertive">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadAnnonces()" aria-label="Réessayer de charger les annonces">Réessayer</button>
    </div>

    <app-empty-state 
      *ngIf="!loading && !error && annonces.length === 0"
      message="Aucune annonce trouvée"
      subtext="Commencez par créer votre première annonce ou réinitialisez les filtres pour voir toutes les annonces disponibles."
      [primaryAction]="emptyStatePrimaryAction"
      [secondaryAction]="emptyStateSecondaryAction">
    </app-empty-state>

    <section *ngIf="!loading && !error && annonces.length > 0" aria-labelledby="results-title">
      <h2 id="results-title" class="sr-only">Résultats de la recherche</h2>
      <app-generic-table
        [columns]="columns"
        [data]="annonces"
        [actions]="actions"
        [showPagination]="false"
        [enableSort]="false"
        (rowAction)="onRowAction($event)">
      </app-generic-table>

      <nav class="pagination-section" *ngIf="page" aria-label="Pagination des annonces">
        <div class="pagination-info" role="status" aria-live="polite">
          Affichage de {{ page.numberOfElements }} sur {{ page.totalElements }} annonces
        </div>
        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="page.first"
            (click)="previousPage()"
            aria-label="Aller à la page précédente"
            [attr.aria-disabled]="page.first"
            (keydown.enter)="!page.first && previousPage()"
            (keydown.space)="$event.preventDefault(); !page.first && previousPage()"
          >
            Précédent
          </button>

          <button
            *ngFor="let pageNum of getPageNumbers(); trackBy: trackByPageNum"
            class="btn-page-num"
            [class.active]="pageNum === currentPage"
            [class.ellipsis]="pageNum === -1"
            [disabled]="pageNum === -1"
            (click)="pageNum !== -1 && goToPage(pageNum)"
            [attr.aria-label]="pageNum === -1 ? null : 'Aller à la page ' + (pageNum + 1)"
            [attr.aria-current]="pageNum === currentPage ? 'page' : null"
            (keydown.enter)="pageNum !== -1 && goToPage(pageNum)"
            (keydown.space)="$event.preventDefault(); pageNum !== -1 && goToPage(pageNum)"
          >
            {{ pageNum === -1 ? '...' : pageNum + 1 }}
          </button>

          <button
            class="btn-page"
            [disabled]="page.last"
            (click)="nextPage()"
            aria-label="Aller à la page suivante"
            [attr.aria-disabled]="page.last"
            (keydown.enter)="!page.last && nextPage()"
            (keydown.space)="$event.preventDefault(); !page.last && nextPage()"
          >
            Suivant
          </button>
        </div>
      </nav>
    </section>
  </main>
</div>
