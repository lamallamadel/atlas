<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Tableau de bord</h1>
    <mat-button-toggle-group 
      [value]="selectedPeriod$ | async" 
      (change)="onPeriodChange($event.value)"
      aria-label="Sélecteur de période">
      <mat-button-toggle value="TODAY">Aujourd'hui</mat-button-toggle>
      <mat-button-toggle value="LAST_7_DAYS">7 jours</mat-button-toggle>
      <mat-button-toggle value="LAST_30_DAYS">30 jours</mat-button-toggle>
    </mat-button-toggle-group>
  </div>
  <div class="page-content">
    <section aria-labelledby="kpi-section-title" class="dashboard-section">
      <h2 id="kpi-section-title" class="sr-only">Indicateurs clés de performance</h2>
      <div class="kpi-grid">
        <div 
          *ngFor="let key of getKpiCardKeys(); trackBy: trackByKey"
          class="kpi-card-wrapper"
          [@itemAnimation]>
          <div 
            class="kpi-card"
            [class.kpi-card--loading]="kpiCards[key].loading"
            [class.kpi-card--clickable]="!kpiCards[key].loading && !kpiCards[key].error"
            [class.kpi-card--error]="kpiCards[key].error"
            (click)="onKpiCardClick(key)"
            (keydown.enter)="onKpiCardClick(key, $event)"
            (keydown.space)="onKpiCardClick(key, $event)"
            [tabindex]="!kpiCards[key].loading && !kpiCards[key].error ? 0 : -1"
            role="button"
            [attr.aria-label]="kpiCards[key].title + ': ' + (kpiCards[key].loading ? 'Chargement en cours' : kpiCards[key].error ? 'Erreur' : kpiCards[key].displayValue)"
            [attr.aria-disabled]="kpiCards[key].loading || kpiCards[key].error ? 'true' : 'false'">
            
            <div class="kpi-card__header">
              <div class="kpi-card__icon-container" [style.background]="'linear-gradient(135deg, ' + kpiCards[key].color + ' 0%, ' + kpiCards[key].color + 'cc 100%)'">
                <mat-icon class="kpi-card__icon" aria-hidden="true">{{kpiCards[key].icon}}</mat-icon>
                <div class="kpi-card__badge" [style.background-color]="kpiCards[key].badgeColor" aria-hidden="true"></div>
              </div>
              <div class="kpi-card__title-section">
                <h3 class="kpi-card__title">{{kpiCards[key].title}}</h3>
                <p class="kpi-card__description" *ngIf="kpiCards[key].description">{{kpiCards[key].description}}</p>
              </div>
            </div>
            
            <app-skeleton-loader *ngIf="kpiCards[key].loading" variant="dashboard-kpi" aria-label="Chargement des données"></app-skeleton-loader>
            
            <div *ngIf="!kpiCards[key].loading" class="kpi-card__content">
              <div *ngIf="kpiCards[key].error" class="kpi-card__error" role="alert" aria-live="assertive">
                <mat-icon color="warn" aria-hidden="true">error</mat-icon>
                <span>{{kpiCards[key].error}}</span>
              </div>
              
              <div *ngIf="!kpiCards[key].error" class="kpi-card__body">
                <div class="kpi-card__metric">
                  <span class="kpi-card__value" [style.color]="kpiCards[key].color" aria-live="polite" aria-atomic="true">
                    {{kpiCards[key].displayValue}}
                  </span>
                  <span class="kpi-card__label" *ngIf="selectedPeriod$ | async as period">
                    sur {{getPeriodLabel(period)}}
                  </span>
                </div>
                
                <div class="kpi-card__trend" *ngIf="kpiCards[key].trend">
                  <div class="kpi-card__trend-indicator" 
                       [class.kpi-card__trend-indicator--positive]="kpiCards[key].trendValue > 0"
                       [class.kpi-card__trend-indicator--negative]="kpiCards[key].trendValue < 0"
                       [class.kpi-card__trend-indicator--neutral]="kpiCards[key].trendValue === 0">
                    <mat-icon class="kpi-card__trend-icon" aria-hidden="true">
                      {{kpiCards[key].trendValue > 0 ? 'trending_up' : kpiCards[key].trendValue < 0 ? 'trending_down' : 'trending_flat'}}
                    </mat-icon>
                    <span class="kpi-card__trend-value">{{kpiCards[key].trend}}</span>
                  </div>
                </div>
                
                <div class="kpi-card__chart" aria-hidden="true">
                  <canvas 
                    [id]="'chart-' + key"
                    #annoncesChart 
                    *ngIf="key === 'annoncesActives'"
                    class="kpi-card__sparkline"
                    role="img"
                    [attr.aria-label]="'Graphique de tendance pour ' + kpiCards[key].title"></canvas>
                  <canvas 
                    [id]="'chart-' + key"
                    #dossiersChart 
                    *ngIf="key === 'dossiersATraiter'"
                    class="kpi-card__sparkline"
                    role="img"
                    [attr.aria-label]="'Graphique de tendance pour ' + kpiCards[key].title"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section aria-labelledby="dossiers-section-title" class="dashboard-section">
      <h2 id="dossiers-section-title" class="sr-only">Dossiers récents</h2>
      <div class="grid-container">
        <div class="grid-row">
          <div class="grid-col-12">
            <mat-card class="section-card scrollable-card" aria-labelledby="recent-dossiers-title">
              <mat-card-header>
                <div mat-card-avatar class="kpi-icon-container" style="background-color: #4caf50;" aria-hidden="true">
                  <mat-icon class="kpi-icon" aria-hidden="true">history</mat-icon>
                </div>
                <mat-card-title class="kpi-card-title">
                  <h3 id="recent-dossiers-title">Derniers dossiers</h3>
                </mat-card-title>
                <div class="export-actions">
                  <button mat-icon-button 
                          (click)="exportToCSV()" 
                          [disabled]="isExportingToCSV || recentDossiers.length === 0"
                          matTooltip="Exporter en CSV"
                          aria-label="Exporter les dossiers en CSV">
                    <mat-icon>file_download</mat-icon>
                  </button>
                  <button mat-icon-button 
                          (click)="exportToPDF()" 
                          [disabled]="isExportingToPDF || recentDossiers.length === 0"
                          matTooltip="Exporter en PDF"
                          aria-label="Exporter les dossiers en PDF">
                    <mat-icon>picture_as_pdf</mat-icon>
                  </button>
                </div>
              </mat-card-header>
              
              <mat-card-content class="scrollable-content">
                <div class="dossiers-filters">
                  <mat-button-toggle-group 
                    [value]="selectedDossierFilter$ | async" 
                    (change)="onDossierFilterChange($event.value)"
                    aria-label="Filtre des dossiers">
                    <mat-button-toggle value="A_TRAITER">À traiter</mat-button-toggle>
                    <mat-button-toggle value="RECENTS">Récents</mat-button-toggle>
                    <mat-button-toggle value="ASSIGNES">Assignés à moi</mat-button-toggle>
                  </mat-button-toggle-group>
                </div>

                <app-skeleton-loader *ngIf="loadingRecent" variant="list" [rows]="5" aria-label="Chargement des dossiers récents"></app-skeleton-loader>
                
                <div *ngIf="!loadingRecent && errorRecent" class="kpi-error" role="alert" aria-live="assertive">
                  <mat-icon color="warn" aria-hidden="true">error</mat-icon>
                  <span>{{errorRecent}}</span>
                </div>
                
                <app-empty-state
                  *ngIf="!loadingRecent && !errorRecent && recentDossiers.length === 0"
                  message="Aucun dossier récent"
                  [primaryAction]="getEmptyStatePrimaryAction()"
                  [secondaryAction]="getEmptyStateSecondaryAction()">
                </app-empty-state>
                
                <div *ngIf="!loadingRecent && !errorRecent && recentDossiers.length > 0" class="dossiers-list" role="list" [@listStaggerAnimation]="recentDossiers.length">
                  <mat-card 
                    *ngFor="let dossier of recentDossiers; trackBy: trackByDossierId" 
                    class="dossier-item" 
                    [@itemAnimation] 
                    appearance="outlined" 
                    role="listitem"
                    tabindex="0"
                    [attr.aria-label]="'Dossier ' + dossier.id + ', ' + (dossier.leadName || 'Sans nom')">
                    <mat-card-content>
                      <div class="dossier-info">
                        <div class="dossier-field">
                          <mat-icon class="field-icon" aria-hidden="true">tag</mat-icon>
                          <span class="field-label">ID:</span>
                          <span class="field-value">{{dossier.id}}</span>
                        </div>
                        <div class="dossier-field" *ngIf="dossier.leadName">
                          <mat-icon class="field-icon" aria-hidden="true">person</mat-icon>
                          <span class="field-label">Lead:</span>
                          <span class="field-value">{{dossier.leadName}}</span>
                        </div>
                        <div class="dossier-field" *ngIf="dossier.leadPhone">
                          <mat-icon class="field-icon" aria-hidden="true">phone</mat-icon>
                          <span class="field-label">Téléphone:</span>
                          <span class="field-value">{{dossier.leadPhone}}</span>
                        </div>
                        <div class="dossier-field">
                          <mat-icon class="field-icon" aria-hidden="true">info</mat-icon>
                          <span class="field-label">Statut:</span>
                          <span class="field-value">{{dossier.status}}</span>
                        </div>
                        <div class="dossier-field">
                          <mat-icon class="field-icon" aria-hidden="true">event</mat-icon>
                          <span class="field-label">Créé le:</span>
                          <span class="field-value">{{dossier.createdAt | date:'short'}}</span>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </mat-card-content>
            </mat-card>
          </div>


        </div>
      </div>
    </section>
  </div>
</div>
