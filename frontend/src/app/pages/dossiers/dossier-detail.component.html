<div class="page-container">
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">
      <span class="back-icon">←</span>
      Retour aux dossiers
    </button>
  </div>

  <div class="page-content">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des détails du dossier...</p>
    </div>

    <div *ngIf="error && !loading" class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadDossier()">Réessayer</button>
    </div>

    <div *ngIf="!loading && !error && dossier" class="detail-content">
      <div class="dossier-header">
        <div class="dossier-title-section">
          <h2 class="dossier-title">
            Dossier #{{ dossier.id }} — {{ dossier.leadName || 'Sans nom' }}/{{ dossier.leadPhone || 'Sans téléphone' }}
          </h2>
          <app-badge-status [status]="dossier.status" entityType="dossier"></app-badge-status>
        </div>
        <button
          class="btn-change-status"
          (click)="toggleStatusChange()"
        >
          Changer statut
        </button>
      </div>

      <div *ngIf="dossier.existingOpenDossierId" class="warning-message">
        <strong>ℹ️ Doublon détecté :</strong>
        un dossier ouvert existe déjà (#{{ dossier.existingOpenDossierId }}).
        <a class="link" [routerLink]="['/dossiers', dossier.existingOpenDossierId]">Ouvrir</a>
      </div>

      <div *ngIf="showStatusChange" class="status-change-section">
        <div *ngIf="successMessage" class="success-message">
          {{ successMessage }}
        </div>

        <div *ngIf="statusError" class="error-message">
          {{ statusError }}
        </div>

        <div *ngIf="isStatusChangeDisabled()" class="warning-message">
          <strong>⚠️ Statut terminal :</strong> {{ getStatusChangeTooltip() }}
        </div>

        <div class="status-change-form">
          <div class="form-group">
            <label for="status-select" class="form-label">Nouveau statut :</label>
            <select
              id="status-select"
              class="form-select"
              [(ngModel)]="selectedStatus"
              [disabled]="updatingStatus || isStatusChangeDisabled()"
              [title]="getStatusChangeTooltip()"
            >
              <option *ngFor="let status of getAvailableStatusOptions()" [value]="status">
                {{ status === DossierStatus.NEW ? 'Nouveau' :
                   status === DossierStatus.QUALIFIED ? 'Qualifié' :
                   status === DossierStatus.APPOINTMENT ? 'Rendez-vous' :
                   status === DossierStatus.WON ? 'Gagné' :
                   status === DossierStatus.LOST ? 'Perdu' : status }}
              </option>
            </select>
          </div>

          <button
            class="btn-update-status"
            (click)="updateStatus()"
            [disabled]="updatingStatus || !selectedStatus || isStatusChangeDisabled()"
          >
            <span *ngIf="updatingStatus" class="spinner-small"></span>
            <span *ngIf="!updatingStatus">Mettre à jour le statut</span>
            <span *ngIf="updatingStatus">Mise à jour...</span>
          </button>

          <button
            class="btn-cancel"
            (click)="toggleStatusChange()"
            [disabled]="updatingStatus"
          >
            Annuler
          </button>
        </div>
      </div>

      <div class="sections-container">
        <mat-card class="info-section">
          <mat-card-header>
            <mat-card-title>Lead</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="isLeadEmpty()" class="lead-empty-state">
              <p class="lead-empty-message">Lead non renseigné</p>
              <button
                class="btn-add-lead"
                (click)="toggleLeadForm()"
                *ngIf="!showLeadForm"
              >
                Ajouter un contact
              </button>

              <div *ngIf="showLeadForm" class="lead-form-section">
                <div *ngIf="leadSuccessMessage" class="success-message">
                  {{ leadSuccessMessage }}
                </div>

                <div *ngIf="leadError" class="error-message">
                  {{ leadError }}
                </div>

                <div class="lead-form">
                  <div class="form-group">
                    <label for="lead-name" class="form-label">Nom :</label>
                    <input
                      id="lead-name"
                      type="text"
                      class="form-input"
                      [(ngModel)]="leadFormName"
                      [disabled]="updatingLead"
                      placeholder="Nom du contact"
                    />
                  </div>

                  <div class="form-group">
                    <label for="lead-phone" class="form-label">Téléphone :</label>
                    <input
                      id="lead-phone"
                      type="text"
                      class="form-input"
                      [(ngModel)]="leadFormPhone"
                      [disabled]="updatingLead"
                      placeholder="Numéro de téléphone"
                    />
                  </div>

                  <div class="form-actions">
                    <button
                      class="btn-update-lead"
                      (click)="updateLead()"
                      [disabled]="updatingLead || !leadFormName || !leadFormPhone"
                    >
                      <span *ngIf="updatingLead" class="spinner-small"></span>
                      <span *ngIf="!updatingLead">Enregistrer</span>
                      <span *ngIf="updatingLead">Enregistrement...</span>
                    </button>

                    <button
                      class="btn-cancel"
                      (click)="toggleLeadForm()"
                      [disabled]="updatingLead"
                    >
                      Annuler
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="!isLeadEmpty()" class="field-group">
              <div class="field-row">
                <span class="field-label">Nom :</span>
                <span class="field-value">{{ dossier.leadName || '—' }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Téléphone :</span>
                <span class="field-value">{{ dossier.leadPhone || '—' }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Source :</span>
                <span class="field-value">{{ dossier.leadSource || '—' }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Origine dossier :</span>
                <span class="field-value">{{ dossier.source || '—' }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Score :</span>
                <span class="field-value">{{ (dossier.score !== undefined && dossier.score !== null) ? dossier.score : '—' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="info-section">
          <mat-card-header>
            <mat-card-title>Parties prenantes</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p *ngIf="!dossier.parties || dossier.parties.length === 0" class="muted">—</p>
            <div *ngIf="dossier.parties && dossier.parties.length > 0" class="parties-table-wrapper">
              <table class="parties-table">
                <thead>
                  <tr>
                    <th>Rôle</th>
                    <th>Nom</th>
                    <th>Téléphone</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of dossier.parties">
                    <td>{{ p.role }}</td>
                    <td>{{ (p.firstName || '') + (p.lastName ? ' ' + p.lastName : '') || '—' }}</td>
                    <td>{{ p.phone || '—' }}</td>
                    <td>{{ p.email || '—' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="info-section">
          <mat-card-header>
            <mat-card-title>Annonce</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="field-group">
              <div class="field-row">
                <span class="field-label">Annonce ID :</span>
                <span class="field-value">{{ dossier.annonceId || '—' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="info-section">
          <mat-card-header>
            <mat-card-title>Système</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="field-group">
              <div class="field-row">
                <span class="field-label">Créé le :</span>
                <span class="field-value">{{ formatDate(dossier.createdAt) }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Créé par :</span>
                <span class="field-value">{{ dossier.createdBy || '—' }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Modifié le :</span>
                <span class="field-value">{{ formatDate(dossier.updatedAt) }}</span>
              </div>

              <div class="field-row">
                <span class="field-label">Modifié par :</span>
                <span class="field-value">{{ dossier.updatedBy || '—' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <mat-expansion-panel class="advanced-section">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Avancé
          </mat-panel-title>
        </mat-expansion-panel-header>
        
        <div class="advanced-content">
          <div class="field-row">
            <span class="field-label">ID Dossier :</span>
            <span class="field-value">{{ dossier.id }}</span>
          </div>
          <div class="field-row" *ngIf="dossier.annonceId">
            <span class="field-label">ID Annonce :</span>
            <span class="field-value">{{ dossier.annonceId }}</span>
          </div>

          <div class="field-row">
            <span class="field-label">Date de création (ISO) :</span>
            <span class="field-value">{{ dossier.createdAt }}</span>
          </div>

          <div class="field-row">
            <span class="field-label">Date de modification (ISO) :</span>
            <span class="field-value">{{ dossier.updatedAt }}</span>
          </div>
        </div>
      </mat-expansion-panel>
    </div>
  </div>
</div>
