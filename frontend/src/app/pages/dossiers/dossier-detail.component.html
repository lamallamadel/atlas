<div class="page-container">
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">
      <span class="back-icon">‚Üê</span>
      Retour aux dossiers
    </button>
  </div>

  <div class="page-content">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des d√©tails du dossier...</p>
    </div>

    <div *ngIf="error && !loading" class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadDossier()">R√©essayer</button>
    </div>

    <div *ngIf="!loading && !error && dossier" class="detail-content">
      <div class="dossier-header">
        <div class="dossier-title-section">
          <h2 class="dossier-title">
            Dossier #{{ dossier.id }} ‚Äî {{ dossier.leadName || 'Sans nom' }}/{{ dossier.leadPhone || 'Sans t√©l√©phone' }}
          </h2>
          <app-badge-status [status]="dossier.status" entityType="dossier"></app-badge-status>
        </div>
        <button
          class="btn-change-status"
          (click)="toggleStatusChange()"
        >
          Changer statut
        </button>
      </div>

      <div *ngIf="dossier.existingOpenDossierId" class="warning-message">
        <strong>‚ÑπÔ∏è Doublon d√©tect√© :</strong>
        un dossier ouvert existe d√©j√† (#{{ dossier.existingOpenDossierId }}).
        <a class="link" [routerLink]="['/dossiers', dossier.existingOpenDossierId]">Ouvrir</a>
      </div>

      <div *ngIf="showStatusChange" class="status-change-section">
        <div *ngIf="successMessage" class="success-message">
          {{ successMessage }}
        </div>

        <div *ngIf="statusError" class="error-message">
          {{ statusError }}
        </div>

        <div *ngIf="isStatusChangeDisabled()" class="warning-message">
          <strong>‚ö†Ô∏è Statut terminal :</strong> {{ getStatusChangeTooltip() }}
        </div>

        <div class="status-change-form">
          <div class="form-group">
            <label for="status-select" class="form-label">Nouveau statut :</label>
            <select
              id="status-select"
              class="form-select"
              [(ngModel)]="selectedStatus"
              [disabled]="updatingStatus || isStatusChangeDisabled()"
              [title]="getStatusChangeTooltip()"
            >
              <option *ngFor="let status of getAvailableStatusOptions()" [value]="status">
                {{ status === DossierStatus.NEW ? 'Nouveau' :
                   status === DossierStatus.QUALIFIED ? 'Qualifi√©' :
                   status === DossierStatus.APPOINTMENT ? 'Rendez-vous' :
                   status === DossierStatus.WON ? 'Gagn√©' :
                   status === DossierStatus.LOST ? 'Perdu' : status }}
              </option>
            </select>
          </div>

          <button
            class="btn-update-status"
            (click)="updateStatus()"
            [disabled]="updatingStatus || !selectedStatus || isStatusChangeDisabled()"
          >
            <span *ngIf="updatingStatus" class="spinner-small"></span>
            <span *ngIf="!updatingStatus">Mettre √† jour le statut</span>
            <span *ngIf="updatingStatus">Mise √† jour...</span>
          </button>

          <button
            class="btn-cancel"
            (click)="toggleStatusChange()"
            [disabled]="updatingStatus"
          >
            Annuler
          </button>
        </div>
      </div>

      <mat-tab-group class="tabs-container">
        <mat-tab label="Informations">
          <div class="tab-content">
            <div class="sections-container">
              <mat-card class="info-section">
                <mat-card-header>
                  <mat-card-title>Lead</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div *ngIf="isLeadEmpty()" class="lead-empty-state">
                    <p class="lead-empty-message">Lead non renseign√©</p>
                    <button
                      class="btn-add-lead"
                      (click)="toggleLeadForm()"
                      *ngIf="!showLeadForm"
                    >
                      Ajouter un contact
                    </button>

                    <div *ngIf="showLeadForm" class="lead-form-section">
                      <div *ngIf="leadSuccessMessage" class="success-message">
                        {{ leadSuccessMessage }}
                      </div>

                      <div *ngIf="leadError" class="error-message">
                        {{ leadError }}
                      </div>

                      <div class="lead-form">
                        <div class="form-group">
                          <label for="lead-name" class="form-label">Nom :</label>
                          <input
                            id="lead-name"
                            type="text"
                            class="form-input"
                            [(ngModel)]="leadFormName"
                            [disabled]="updatingLead"
                            placeholder="Nom du contact"
                          />
                        </div>

                        <div class="form-group">
                          <label for="lead-phone" class="form-label">T√©l√©phone :</label>
                          <input
                            id="lead-phone"
                            type="text"
                            class="form-input"
                            [(ngModel)]="leadFormPhone"
                            [disabled]="updatingLead"
                            placeholder="Num√©ro de t√©l√©phone"
                          />
                        </div>

                        <div class="form-actions">
                          <button
                            class="btn-update-lead"
                            (click)="updateLead()"
                            [disabled]="updatingLead || !leadFormName || !leadFormPhone"
                          >
                            <span *ngIf="updatingLead" class="spinner-small"></span>
                            <span *ngIf="!updatingLead">Enregistrer</span>
                            <span *ngIf="updatingLead">Enregistrement...</span>
                          </button>

                          <button
                            class="btn-cancel"
                            (click)="toggleLeadForm()"
                            [disabled]="updatingLead"
                          >
                            Annuler
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="!isLeadEmpty()" class="field-group">
                    <div class="field-row">
                      <span class="field-label">Nom :</span>
                      <span class="field-value">{{ dossier.leadName || '‚Äî' }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">T√©l√©phone :</span>
                      <span class="field-value">{{ dossier.leadPhone || '‚Äî' }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Source :</span>
                      <span class="field-value">{{ dossier.leadSource || '‚Äî' }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Origine dossier :</span>
                      <span class="field-value">{{ dossier.source || '‚Äî' }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Score :</span>
                      <span class="field-value">{{ (dossier.score !== undefined && dossier.score !== null) ? dossier.score : '‚Äî' }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="info-section">
                <mat-card-header>
                  <mat-card-title>Annonce</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="field-group">
                    <div class="field-row">
                      <span class="field-label">Annonce ID :</span>
                      <span class="field-value">{{ dossier.annonceId || '‚Äî' }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="info-section">
                <mat-card-header>
                  <mat-card-title>Syst√®me</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="field-group">
                    <div class="field-row">
                      <span class="field-label">Cr√©√© le :</span>
                      <span class="field-value">{{ formatDate(dossier.createdAt) }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Cr√©√© par :</span>
                      <span class="field-value">{{ dossier.createdBy || '‚Äî' }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Modifi√© le :</span>
                      <span class="field-value">{{ formatDate(dossier.updatedAt) }}</span>
                    </div>

                    <div class="field-row">
                      <span class="field-label">Modifi√© par :</span>
                      <span class="field-value">{{ dossier.updatedBy || '‚Äî' }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <mat-expansion-panel class="advanced-section">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Avanc√©
                </mat-panel-title>
              </mat-expansion-panel-header>
              
              <div class="advanced-content">
                <div class="field-row">
                  <span class="field-label">ID Dossier :</span>
                  <span class="field-value">{{ dossier.id }}</span>
                </div>
                <div class="field-row" *ngIf="dossier.annonceId">
                  <span class="field-label">ID Annonce :</span>
                  <span class="field-value">{{ dossier.annonceId }}</span>
                </div>

                <div class="field-row">
                  <span class="field-label">Date de cr√©ation (ISO) :</span>
                  <span class="field-value">{{ dossier.createdAt }}</span>
                </div>

                <div class="field-row">
                  <span class="field-label">Date de modification (ISO) :</span>
                  <span class="field-value">{{ dossier.updatedAt }}</span>
                </div>
              </div>
            </mat-expansion-panel>
          </div>
        </mat-tab>

        <mat-tab label="Parties prenantes">
          <div class="tab-content">
            <div class="tab-header-actions">
              <button class="btn-add" (click)="togglePartieForm()">
                Ajouter
              </button>
            </div>

            <div class="data-table-wrapper">
              <table class="data-table" *ngIf="dossier.parties && dossier.parties.length > 0">
                <thead>
                  <tr>
                    <th>R√¥le</th>
                    <th>Nom</th>
                    <th>T√©l√©phone</th>
                    <th>Email</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let partie of dossier.parties">
                    <td>{{ getRoleLabel(partie.role) }}</td>
                    <td>{{ (partie.firstName || '') + (partie.lastName ? ' ' + partie.lastName : '') || '‚Äî' }}</td>
                    <td>{{ partie.phone || '‚Äî' }}</td>
                    <td>{{ partie.email || '‚Äî' }}</td>
                    <td>
                      <button class="btn-edit" (click)="editPartie(partie)">√âditer</button>
                      <button class="btn-delete" (click)="deletePartie(partie)">Supprimer</button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <p *ngIf="!dossier.parties || dossier.parties.length === 0" class="empty-message">
                Aucune partie prenante enregistr√©e.
              </p>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Messages">
          <div class="tab-content">
            <div class="tab-header-actions">
              <button class="btn-add" (click)="openMessageDialog()">
                Nouveau message
              </button>
            </div>

            <div *ngIf="loadingMessages" class="loading-state">
              <div class="spinner-small"></div>
              <p>Chargement des messages...</p>
            </div>

            <div *ngIf="!loadingMessages" class="timeline-view">
              <div *ngIf="getMessagesSorted().length === 0" class="empty-message">
                Aucun message disponible.
              </div>
              <div *ngFor="let message of getMessagesSorted()" class="message-card">
                <div class="message-card-header">
                  <span class="message-timestamp">{{ formatMessageTimestamp(message.timestamp) }}</span>
                  <div class="message-badges">
                    <span [class]="getChannelBadgeClass(message.channel)">{{ message.channel }}</span>
                    <span [class]="getDirectionBadgeClass(message.direction)">
                      {{ message.direction === 'INBOUND' ? 'Entrant' : 'Sortant' }}
                    </span>
                  </div>
                </div>
                <div class="message-card-body">
                  <p class="message-content">
                    {{ truncateContent(message.content) }}
                    <span *ngIf="shouldShowVoirPlus(message.content)" class="voir-plus">Voir plus</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Rendez-vous">
          <div class="tab-content">
            <div class="tab-header-actions">
              <button class="btn-add" (click)="openAppointmentDialog()">
                Planifier
              </button>
            </div>

            <div *ngIf="loadingAppointments" class="loading-state">
              <div class="spinner-small"></div>
              <p>Chargement des rendez-vous...</p>
            </div>

            <div *ngIf="!loadingAppointments" class="data-table-wrapper">
              <table class="data-table" *ngIf="appointments.length > 0">
                <thead>
                  <tr>
                    <th>Date/Heure</th>
                    <th>Lieu</th>
                    <th>Assign√© √†</th>
                    <th>Statut</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let appointment of appointments">
                    <td>
                      <div class="appointment-datetime">
                        <div class="datetime-start">{{ formatAppointmentDateTime(appointment.startTime) }}</div>
                        <div class="datetime-end">‚Üí {{ formatAppointmentDateTime(appointment.endTime) }}</div>
                      </div>
                    </td>
                    <td>{{ appointment.location || '‚Äî' }}</td>
                    <td>{{ appointment.assignedTo || '‚Äî' }}</td>
                    <td>
                      <span [class]="getAppointmentStatusBadgeClass(appointment.status)">
                        {{ getAppointmentStatusLabel(appointment.status) }}
                      </span>
                    </td>
                    <td>{{ appointment.notes || '‚Äî' }}</td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn-edit" (click)="editAppointment(appointment)">√âditer</button>
                        <button 
                          class="btn-complete" 
                          (click)="completeAppointment(appointment)"
                          *ngIf="appointment.status === 'SCHEDULED'"
                        >
                          Terminer
                        </button>
                        <button class="btn-delete" (click)="deleteAppointment(appointment)">Supprimer</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <p *ngIf="appointments.length === 0" class="empty-message">
                Aucun rendez-vous planifi√©.
              </p>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Consentements">
          <div class="tab-content">
            <div *ngIf="consentementsLoading" class="loading-state">
              <div class="spinner-small"></div>
              <p>Chargement des consentements...</p>
            </div>

            <div *ngIf="!consentementsLoading">
              <div class="consent-cards-grid">
                <div *ngFor="let group of consentementGroups" class="consent-card">
                  <div class="consent-card-header">
                    <span class="consent-channel-icon">
                      {{ group.channel === ConsentementChannel.EMAIL ? 'üìß' : 'üì±' }}
                    </span>
                    <h3 class="consent-channel-title">{{ getChannelLabel(group.channel) }}</h3>
                  </div>
                  <div class="consent-card-body">
                    <div *ngIf="group.current" class="consent-current-status">
                      <div class="consent-status-row">
                        <span class="consent-label">Statut actuel :</span>
                        <span [class]="getConsentementStatusBadgeClass(group.current.status)">
                          {{ getConsentementStatusLabel(group.current.status) }}
                        </span>
                      </div>
                      <div class="consent-date-row">
                        <span class="consent-date-label">
                          {{ group.current.status === ConsentementStatus.GRANTED ? 'Accord√© le' : 
                             group.current.status === ConsentementStatus.REVOKED ? 'R√©voqu√© le' : 
                             'Modifi√© le' }} :
                        </span>
                        <span class="consent-date-value">{{ getConsentDate(group.current) }}</span>
                      </div>
                    </div>
                    <div *ngIf="!group.current" class="consent-no-status">
                      <span class="consent-no-status-text">Aucun consentement enregistr√©</span>
                    </div>

                    <div class="consent-actions">
                      <button 
                        class="consent-btn consent-btn-granted"
                        [class.active]="group.current?.status === ConsentementStatus.GRANTED"
                        (click)="toggleConsentement(group, ConsentementStatus.GRANTED)"
                        [disabled]="group.current?.status === ConsentementStatus.GRANTED"
                      >
                        Accorder
                      </button>
                      <button 
                        class="consent-btn consent-btn-denied"
                        [class.active]="group.current?.status === ConsentementStatus.DENIED"
                        (click)="toggleConsentement(group, ConsentementStatus.DENIED)"
                        [disabled]="group.current?.status === ConsentementStatus.DENIED"
                      >
                        Refuser
                      </button>
                      <button 
                        class="consent-btn consent-btn-revoked"
                        [class.active]="group.current?.status === ConsentementStatus.REVOKED"
                        (click)="toggleConsentement(group, ConsentementStatus.REVOKED)"
                        [disabled]="group.current?.status === ConsentementStatus.REVOKED"
                      >
                        R√©voquer
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <mat-expansion-panel class="consent-history-section">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    Historique des consentements
                  </mat-panel-title>
                </mat-expansion-panel-header>
                
                <div class="consent-history-content">
                  <div *ngIf="getConsentementsHistory().length === 0" class="empty-message">
                    Aucun historique de consentement.
                  </div>
                  <div *ngIf="getConsentementsHistory().length > 0" class="data-table-wrapper">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>Canal</th>
                          <th>Statut</th>
                          <th>Date</th>
                          <th>Utilisateur</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let consent of getConsentementsHistory()">
                          <td>
                            <span [class]="getChannelBadgeClass(consent.channel)">
                              {{ getChannelLabel(consent.channel) }}
                            </span>
                          </td>
                          <td>
                            <span [class]="getConsentementStatusBadgeClass(consent.status)">
                              {{ getConsentementStatusLabel(consent.status) }}
                            </span>
                          </td>
                          <td>{{ formatDate(consent.updatedAt) }}</td>
                          <td>{{ getUserFromMeta(consent) }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Historique">
          <div class="tab-content">
            <div class="audit-list">
              <div *ngIf="auditEvents.length === 0" class="empty-message">
                Aucun √©v√©nement d'audit disponible.
              </div>
              <div *ngFor="let event of auditEvents" class="audit-item">
                <div class="audit-marker"></div>
                <div class="audit-content">
                  <div class="audit-header">
                    <span class="audit-timestamp">{{ formatDateTime(event.timestamp) }}</span>
                    <span class="audit-actor">{{ event.actor }}</span>
                  </div>
                  <div class="audit-body">
                    <span class="audit-action">{{ event.action }}</span>
                    <p class="audit-details">{{ event.details }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>
