<div class="page-container">
  <header class="page-header">
    <h1 class="page-title">Dossiers</h1>
    <button class="btn-create" (click)="createDossier()" aria-label="Créer un nouveau dossier">
      <span class="btn-icon" aria-hidden="true">+</span>
      Créer un dossier
    </button>
  </header>

  <!-- Desktop Filters -->
  <section *ngIf="!isMobile" aria-label="Filtres de recherche">
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-container">
          <mat-expansion-panel 
            [(expanded)]="filterPanelExpanded"
            class="filter-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon aria-hidden="true">filter_list</mat-icon>
                <span>Filtres</span>
                <span class="filter-count" *ngIf="appliedFilters.length > 0" [attr.aria-label]="appliedFilters.length + ' filtres actifs'">
                  ({{ appliedFilters.length }})
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="filter-content">
              <!-- Filter Fields Grid -->
              <div class="filter-row">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Statut</mat-label>
                  <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onFilterChange()" aria-label="Filtrer par statut">
                    <mat-option value="">Tous</mat-option>
                    <mat-option [value]="DossierStatus.NEW">Nouveau</mat-option>
                    <mat-option [value]="DossierStatus.QUALIFIED">Qualifié</mat-option>
                    <mat-option [value]="DossierStatus.APPOINTMENT">Rendez-vous</mat-option>
                    <mat-option [value]="DossierStatus.WON">Gagné</mat-option>
                    <mat-option [value]="DossierStatus.LOST">Perdu</mat-option>
                  </mat-select>
                  <mat-icon matSuffix aria-hidden="true">filter_alt</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Téléphone</mat-label>
                  <input
                    matInput
                    placeholder="Filtrer par numéro de téléphone"
                    [(ngModel)]="phoneFilter"
                    (keyup.enter)="onFilterChange()"
                    aria-label="Filtrer par numéro de téléphone"
                  />
                  <mat-icon matSuffix aria-hidden="true">search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Annonce</mat-label>
                  <input
                    matInput
                    placeholder="Rechercher une annonce (titre ou ID)"
                    [formControl]="annonceSearchControl"
                    [matAutocomplete]="annonceAuto"
                    (keyup.enter)="onFilterChange()"
                    aria-label="Rechercher une annonce par titre ou ID"
                  />
                  <mat-icon matSuffix aria-hidden="true">search</mat-icon>
                  <mat-autocomplete 
                    #annonceAuto="matAutocomplete" 
                    [displayWith]="displayAnnonceFn.bind(this)"
                    (optionSelected)="onAnnonceSelected($event.option.value); onFilterChange()">
                    <mat-option *ngFor="let a of filteredAnnonces | async; trackBy: trackByAnnonce" [value]="a">
                      {{ a.title || 'Sans titre' }} <span class="muted">(#{{ a.id }})</span>
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </div>

              <!-- Filter Actions -->
              <div class="filter-actions">
                <button mat-raised-button color="primary" (click)="onFilterChange()" aria-label="Appliquer les filtres sélectionnés">
                  <mat-icon aria-hidden="true">check</mat-icon>
                  Appliquer
                </button>
                <button mat-button (click)="clearFilters()" aria-label="Réinitialiser tous les filtres">
                  <mat-icon aria-hidden="true">clear</mat-icon>
                  Réinitialiser
                </button>
                
                <button mat-button [matMenuTriggerFor]="presetMenu" aria-label="Gérer les presets de filtres" aria-haspopup="true">
                  <mat-icon aria-hidden="true">bookmark</mat-icon>
                  Presets
                </button>
                <mat-menu #presetMenu="matMenu" aria-label="Menu des presets">
                  <button mat-menu-item (click)="saveCurrentFilters()" aria-label="Sauvegarder les filtres actuels comme preset">
                    <mat-icon aria-hidden="true">save</mat-icon>
                    <span>Sauvegarder les filtres actuels</span>
                  </button>
                  <mat-divider *ngIf="savedPresets.length > 0" role="separator"></mat-divider>
                  <button 
                    mat-menu-item 
                    *ngFor="let preset of savedPresets; trackBy: trackByPreset"
                    (click)="loadPreset(preset)"
                    [attr.aria-label]="'Charger le preset ' + preset.name">
                    <mat-icon aria-hidden="true">folder</mat-icon>
                    <span>{{ preset.name }}</span>
                    <button 
                      mat-icon-button 
                      (click)="deletePreset(preset, $event)"
                      class="delete-preset-btn"
                      [attr.aria-label]="'Supprimer le preset ' + preset.name">
                      <mat-icon aria-hidden="true">delete</mat-icon>
                    </button>
                  </button>
                  <div *ngIf="savedPresets.length === 0" class="empty-presets" role="status">
                    <span class="empty-text">Aucun preset sauvegardé</span>
                  </div>
                </mat-menu>
              </div>

              <!-- Active Filter Chips -->
              <div class="active-filters-row" *ngIf="appliedFilters.length > 0" role="region" aria-label="Filtres actifs">
                <div class="active-filters-header">
                  <span class="filters-label">Filtres actifs :</span>
                  <button mat-button (click)="clearFilters()" class="clear-all-btn" aria-label="Effacer tous les filtres">
                    <mat-icon aria-hidden="true">clear_all</mat-icon>
                    Tout effacer
                  </button>
                </div>
                <mat-chip-set aria-label="Filtres appliqués" [@listStaggerAnimation]="appliedFilters.length">
                  <mat-chip
                    *ngFor="let filter of appliedFilters; trackBy: trackByFilter"
                    (removed)="removeFilter(filter)"
                    [@itemAnimation]
                    [attr.aria-label]="filter.label + ': ' + filter.displayValue">
                    <strong>{{ filter.label }}:</strong> {{ filter.displayValue }}
                    <button matChipRemove [attr.aria-label]="'Retirer le filtre ' + filter.label">
                      <mat-icon aria-hidden="true">cancel</mat-icon>
                    </button>
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <!-- Mobile Filter Button -->
  <div class="mobile-filter-button" *ngIf="isMobile">
    <button mat-raised-button color="primary" (click)="openMobileFilters()" aria-label="Ouvrir les filtres">
      <mat-icon aria-hidden="true">filter_list</mat-icon>
      Filtres
      <span class="filter-badge" *ngIf="appliedFilters.length > 0" [attr.aria-label]="appliedFilters.length + ' filtres actifs'">
        {{ appliedFilters.length }}
      </span>
    </button>
  </div>

  <main class="page-content">
    <app-loading-skeleton *ngIf="loading" variant="table" [rows]="10" [columns]="8" aria-label="Chargement des dossiers"></app-loading-skeleton>

    <div *ngIf="error && !loading" class="error-state" role="alert" aria-live="assertive">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadDossiers()" aria-label="Réessayer de charger les dossiers">Réessayer</button>
    </div>

    <app-empty-state 
      *ngIf="!loading && !error && dossiers.length === 0"
      [message]="emptyStateMessage"
      [subtext]="emptyStateSubtext"
      [primaryAction]="emptyStatePrimaryAction"
      [secondaryAction]="emptyStateSecondaryAction">
    </app-empty-state>

    <section *ngIf="!loading && !error && dossiers.length > 0" aria-labelledby="results-title">
      <h2 id="results-title" class="sr-only">Résultats de la recherche</h2>
      <app-generic-table
        [columns]="columns"
        [data]="dossiers"
        [actions]="actions"
        [showPagination]="false"
        [enableSort]="false"
        [rowClickable]="true"
        [useKebabMenu]="true"
        [showTableHeader]="true"
        [showInlinePagination]="true"
        [paginationData]="paginationData"
        [counterSingular]="'dossier'"
        [counterPlural]="'dossier(s)'"
        (rowAction)="onRowAction($event)"
        (rowClick)="onRowClick($event)"
        (paginationChange)="onPaginationChange($event)">
      </app-generic-table>

      <nav class="pagination-section" *ngIf="page" aria-label="Pagination des dossiers">
        <div class="pagination-info" role="status" aria-live="polite">
          Affichage de {{ page.numberOfElements }} sur {{ page.totalElements }} dossiers
        </div>
        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="page.first"
            (click)="previousPage()"
            aria-label="Page précédente"
            [attr.aria-disabled]="page.first"
          >
            Précédent
          </button>

          <button
            *ngFor="let pageNum of getPageNumbers(); trackBy: trackByPageNum"
            class="btn-page-num"
            [class.active]="pageNum === currentPage"
            [class.ellipsis]="pageNum === -1"
            [disabled]="pageNum === -1"
            (click)="pageNum !== -1 && goToPage(pageNum)"
            [attr.aria-label]="pageNum === -1 ? null : 'Aller à la page ' + (pageNum + 1)"
            [attr.aria-current]="pageNum === currentPage ? 'page' : null"
          >
            {{ pageNum === -1 ? '...' : pageNum + 1 }}
          </button>

          <button
            class="btn-page"
            [disabled]="page.last"
            (click)="nextPage()"
            aria-label="Page suivante"
            [attr.aria-disabled]="page.last"
          >
            Suivant
          </button>
        </div>
      </nav>
    </section>
  </main>
</div>
