<div class="page-container">
  <div class="page-header">
    <h2 class="page-title">Dossiers</h2>
    <button class="btn-create" (click)="createDossier()">
      <span class="btn-icon">+</span>
      Créer un dossier
    </button>
  </div>

  <div class="filters-section">
    <div class="filter-box">
      <label for="status-filter" class="filter-label">Statut :</label>
      <select
        id="status-filter"
        class="filter-select"
        [(ngModel)]="selectedStatus"
        (change)="onFilterChange()"
      >
        <option value="">Tous</option>
        <option [value]="DossierStatus.NEW">Nouveau</option>
        <option [value]="DossierStatus.QUALIFIED">Qualifié</option>
        <option [value]="DossierStatus.APPOINTMENT">Rendez-vous</option>
        <option [value]="DossierStatus.WON">Gagné</option>
        <option [value]="DossierStatus.LOST">Perdu</option>
      </select>
    </div>

    <div class="filter-box">
      <label for="phone-filter" class="filter-label">Téléphone :</label>
      <input
        id="phone-filter"
        type="text"
        class="filter-input"
        placeholder="Filtrer par téléphone..."
        [(ngModel)]="phoneFilter"
        (keyup.enter)="onFilterChange()"
      />
    </div>

    <div class="filter-box">
      <label for="annonce-filter" class="filter-label">Annonce :</label>
      <input
        id="annonce-filter"
        type="text"
        class="filter-input"
        placeholder="Rechercher une annonce (titre ou ID)..."
        [formControl]="annonceSearchControl"
        [matAutocomplete]="annonceAuto"
        (keyup.enter)="onFilterChange()"
      />
      <mat-autocomplete #annonceAuto="matAutocomplete" [displayWith]="displayAnnonceFn" (optionSelected)="onAnnonceSelected($event.option.value)">
        <mat-option *ngFor="let a of filteredAnnonces | async" [value]="a">
          {{ a.title || 'Sans titre' }} <span class="muted">(#{{ a.id }})</span>
        </mat-option>
      </mat-autocomplete>
    </div>

    <button class="btn-filter" (click)="onFilterChange()">Appliquer les filtres</button>
    <button class="btn-clear" (click)="clearFilters()">Effacer</button>
  </div>

  <div class="page-content">
    <app-loading-skeleton *ngIf="loading" variant="table" [rows]="10" [columns]="8"></app-loading-skeleton>

    <div *ngIf="error && !loading" class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadDossiers()">Réessayer</button>
    </div>

    <app-empty-state 
      *ngIf="!loading && !error && dossiers.length === 0"
      message="Aucun dossier trouvé"
      subtext="Créez votre premier dossier pour commencer à gérer vos prospects ou effacez les filtres pour voir tous les dossiers."
      [primaryAction]="emptyStatePrimaryAction"
      [secondaryAction]="emptyStateSecondaryAction">
    </app-empty-state>

    <div *ngIf="!loading && !error && dossiers.length > 0">
      <app-generic-table
        [columns]="columns"
        [data]="dossiers"
        [actions]="actions"
        [showPagination]="false"
        [enableSort]="false"
        [rowClickable]="true"
        (rowAction)="onRowAction($event)"
        (rowClick)="onRowClick($event)">
      </app-generic-table>

      <div class="pagination-section" *ngIf="page">
        <div class="pagination-info">
          Affichage de {{ page.numberOfElements }} sur {{ page.totalElements }} dossiers
        </div>
        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="page.first"
            (click)="previousPage()"
          >
            Précédent
          </button>

          <button
            *ngFor="let pageNum of getPageNumbers()"
            class="btn-page-num"
            [class.active]="pageNum === currentPage"
            [class.ellipsis]="pageNum === -1"
            [disabled]="pageNum === -1"
            (click)="pageNum !== -1 && goToPage(pageNum)"
          >
            {{ pageNum === -1 ? '...' : pageNum + 1 }}
          </button>

          <button
            class="btn-page"
            [disabled]="page.last"
            (click)="nextPage()"
          >
            Suivant
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
