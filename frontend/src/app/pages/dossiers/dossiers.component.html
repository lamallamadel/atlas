<div class="page-container">
  <div class="page-header">
    <h2 class="page-title">Dossiers</h2>
    <button class="btn-create" (click)="createDossier()">
      <span class="btn-icon">+</span>
      Créer un dossier
    </button>
  </div>

  <!-- Desktop Filters -->
  <div class="filters-container" *ngIf="!isMobile">
    <mat-expansion-panel 
      [(expanded)]="filterPanelExpanded"
      class="filter-panel">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>filter_list</mat-icon>
          <span>Filtres</span>
          <span class="filter-count" *ngIf="appliedFilters.length > 0">
            ({{ appliedFilters.length }})
          </span>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="filter-content">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Statut</mat-label>
            <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onFilterChange()">
              <mat-option value="">Tous</mat-option>
              <mat-option [value]="DossierStatus.NEW">Nouveau</mat-option>
              <mat-option [value]="DossierStatus.QUALIFIED">Qualifié</mat-option>
              <mat-option [value]="DossierStatus.APPOINTMENT">Rendez-vous</mat-option>
              <mat-option [value]="DossierStatus.WON">Gagné</mat-option>
              <mat-option [value]="DossierStatus.LOST">Perdu</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Téléphone</mat-label>
            <input
              matInput
              placeholder="Filtrer par téléphone..."
              [(ngModel)]="phoneFilter"
              (keyup.enter)="onFilterChange()"
            />
            <mat-icon matSuffix>phone</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Annonce</mat-label>
            <input
              matInput
              placeholder="Rechercher une annonce (titre ou ID)..."
              [formControl]="annonceSearchControl"
              [matAutocomplete]="annonceAuto"
              (keyup.enter)="onFilterChange()"
            />
            <mat-icon matSuffix>business</mat-icon>
            <mat-autocomplete 
              #annonceAuto="matAutocomplete" 
              [displayWith]="displayAnnonceFn.bind(this)"
              (optionSelected)="onAnnonceSelected($event.option.value); onFilterChange()">
              <mat-option *ngFor="let a of filteredAnnonces | async" [value]="a">
                {{ a.title || 'Sans titre' }} <span class="muted">(#{{ a.id }})</span>
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>

        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="onFilterChange()">
            <mat-icon>check</mat-icon>
            Appliquer
          </button>
          <button mat-button (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Réinitialiser
          </button>
          
          <div class="preset-menu-container">
            <button mat-button [matMenuTriggerFor]="presetMenu">
              <mat-icon>bookmark</mat-icon>
              Presets
            </button>
            <mat-menu #presetMenu="matMenu">
              <button mat-menu-item (click)="saveCurrentFilters()">
                <mat-icon>save</mat-icon>
                <span>Sauvegarder les filtres actuels</span>
              </button>
              <mat-divider *ngIf="savedPresets.length > 0"></mat-divider>
              <button 
                mat-menu-item 
                *ngFor="let preset of savedPresets"
                (click)="loadPreset(preset)">
                <mat-icon>folder</mat-icon>
                <span>{{ preset.name }}</span>
                <button 
                  mat-icon-button 
                  (click)="deletePreset(preset, $event)"
                  class="delete-preset-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </button>
              <div *ngIf="savedPresets.length === 0" class="empty-presets">
                <span class="empty-text">Aucun preset sauvegardé</span>
              </div>
            </mat-menu>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </div>

  <!-- Mobile Filter Button -->
  <div class="mobile-filter-button" *ngIf="isMobile">
    <button mat-raised-button color="primary" (click)="openMobileFilters()">
      <mat-icon>filter_list</mat-icon>
      Filtres
      <span class="filter-badge" *ngIf="appliedFilters.length > 0">
        {{ appliedFilters.length }}
      </span>
    </button>
  </div>

  <!-- Applied Filters Chips -->
  <div class="applied-filters" *ngIf="appliedFilters.length > 0">
    <span class="filters-label">Filtres actifs:</span>
    <mat-chip-set aria-label="Applied filters">
      <mat-chip
        *ngFor="let filter of appliedFilters"
        (removed)="removeFilter(filter)">
        <strong>{{ filter.label }}:</strong> {{ filter.displayValue }}
        <button matChipRemove>
          <mat-icon>cancel</mat-icon>
        </button>
      </mat-chip>
    </mat-chip-set>
  </div>

  <div class="page-content">
    <app-loading-skeleton *ngIf="loading" variant="table" [rows]="10" [columns]="8"></app-loading-skeleton>

    <div *ngIf="error && !loading" class="error-state">
      <p class="error-message">{{ error }}</p>
      <button class="btn-retry" (click)="loadDossiers()">Réessayer</button>
    </div>

    <app-empty-state 
      *ngIf="!loading && !error && dossiers.length === 0"
      message="Aucun dossier trouvé"
      subtext="Créez votre premier dossier pour commencer à gérer vos prospects ou effacez les filtres pour voir tous les dossiers."
      [primaryAction]="emptyStatePrimaryAction"
      [secondaryAction]="emptyStateSecondaryAction">
    </app-empty-state>

    <div *ngIf="!loading && !error && dossiers.length > 0">
      <app-generic-table
        [columns]="columns"
        [data]="dossiers"
        [actions]="actions"
        [showPagination]="false"
        [enableSort]="false"
        [rowClickable]="true"
        (rowAction)="onRowAction($event)"
        (rowClick)="onRowClick($event)">
      </app-generic-table>

      <div class="pagination-section" *ngIf="page">
        <div class="pagination-info">
          Affichage de {{ page.numberOfElements }} sur {{ page.totalElements }} dossiers
        </div>
        <div class="pagination-controls">
          <button
            class="btn-page"
            [disabled]="page.first"
            (click)="previousPage()"
          >
            Précédent
          </button>

          <button
            *ngFor="let pageNum of getPageNumbers()"
            class="btn-page-num"
            [class.active]="pageNum === currentPage"
            [class.ellipsis]="pageNum === -1"
            [disabled]="pageNum === -1"
            (click)="pageNum !== -1 && goToPage(pageNum)"
          >
            {{ pageNum === -1 ? '...' : pageNum + 1 }}
          </button>

          <button
            class="btn-page"
            [disabled]="page.last"
            (click)="nextPage()"
          >
            Suivant
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
