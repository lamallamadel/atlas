<div class="command-palette-overlay" 
     *ngIf="visible$ | async" 
     (click)="close()"
     (keydown.escape)="close()" 
     role="dialog" 
     aria-modal="true"
     aria-labelledby="command-palette-title"
     aria-describedby="command-palette-description"
     tabindex="-1">
  <div class="command-palette" 
       appFocusTrap
       (click)="$event.stopPropagation()"
       (keydown)="$event.stopPropagation()" 
       role="document">
    
    <!-- Header -->
    <div class="command-header">
      <h2 id="command-palette-title" class="visually-hidden">Palette de commandes</h2>
      <p id="command-palette-description" class="visually-hidden">
        Tapez pour rechercher des commandes, annonces ou dossiers. Utilisez les flèches haut et bas pour naviguer, Entrée pour sélectionner, Échap pour fermer.
      </p>
      <div class="command-search">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          #commandInput
          type="text"
          class="command-input"
          placeholder="Tapez une commande, recherchez des annonces ou dossiers..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          (keydown)="onKeyDown($event)"
          autocomplete="off"
          aria-label="Recherche de commandes"
          aria-autocomplete="list"
          aria-controls="command-list"
          [attr.aria-activedescendant]="'command-item-' + selectedIndex"
        />
        <mat-spinner 
          *ngIf="isSearching" 
          diameter="20" 
          class="search-spinner">
        </mat-spinner>
        <div class="shortcut-hint">
          <kbd>Ctrl+K</kbd>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="command-list" 
         *ngIf="filteredItems.length > 0"
         id="command-list"
         role="listbox">
      <ng-container *ngFor="let group of getGroupedItems()">
        <div class="command-category" role="presentation">
          {{ group.category }}
        </div>
        <div
          *ngFor="let item of group.items; let i = index"
          class="command-item"
          [class.selected]="filteredItems.indexOf(item) === selectedIndex"
          [id]="'command-item-' + filteredItems.indexOf(item)"
          (click)="executeItem(item)"
          (keydown.enter)="executeItem(item)"
          (mouseenter)="selectItem(filteredItems.indexOf(item))"
          role="option"
          [attr.aria-selected]="filteredItems.indexOf(item) === selectedIndex"
          tabindex="-1"
        >
          <div class="command-content">
            <mat-icon class="command-icon">{{ getItemIcon(item) }}</mat-icon>
            <div class="command-details">
              <div class="command-label">{{ getItemLabel(item) }}</div>
              <div class="command-description" *ngIf="getItemDescription(item)">
                {{ getItemDescription(item) }}
              </div>
            </div>
            <div class="command-shortcut" *ngIf="getItemShortcut(item)">
              <kbd>{{ getItemShortcut(item) }}</kbd>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Empty State -->
    <div class="command-empty" *ngIf="filteredItems.length === 0 && !isSearching" role="status" aria-live="polite">
      <mat-icon aria-hidden="true">search_off</mat-icon>
      <p *ngIf="searchQuery">Aucun résultat trouvé pour "{{ searchQuery }}"</p>
      <p *ngIf="!searchQuery">Commencez à taper pour rechercher...</p>
    </div>

    <!-- Loading State -->
    <div class="command-loading" *ngIf="isSearching && searchQuery.length >= 2" role="status" aria-live="polite">
      <mat-spinner diameter="40" aria-label="Recherche en cours"></mat-spinner>
      <p>Recherche en cours...</p>
    </div>

    <!-- Footer -->
    <div class="command-footer">
      <div class="footer-shortcuts">
        <span class="footer-shortcut">
          <kbd>↑</kbd><kbd>↓</kbd> naviguer
        </span>
        <span class="footer-shortcut">
          <kbd>↵</kbd> sélectionner
        </span>
        <span class="footer-shortcut">
          <kbd>Esc</kbd> fermer
        </span>
      </div>
    </div>
  </div>
</div>
