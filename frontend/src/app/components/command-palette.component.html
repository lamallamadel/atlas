<div class="command-palette-overlay"
     *ngIf="visible$ | async"
     (click)="close()"
     (keydown.escape)="close()"
     role="dialog"
     aria-modal="true"
     aria-labelledby="command-palette-title"
     aria-describedby="command-palette-description"
     tabindex="-1">
  <div class="command-palette glass-card-elevated"
       appFocusTrap
       (click)="$event.stopPropagation()"
       (keydown)="$event.stopPropagation()"
       role="document">

    <!-- Header -->
    <div class="command-header">
      <h2 id="command-palette-title" class="visually-hidden">Palette de commandes</h2>
      <p id="command-palette-description" class="visually-hidden">
        Tapez pour rechercher des commandes, annonces ou dossiers. Utilisez les flèches haut et bas pour naviguer, Entrée pour sélectionner, Échap pour fermer.
      </p>
      <div class="command-search">
        <mat-icon class="search-icon" aria-hidden="true">search</mat-icon>
        <input
          #commandInput
          type="text"
          class="command-input"
          placeholder="Tapez une commande, un nom de client, 'note', 'rdv'..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          (keydown)="onKeyDown($event)"
          autocomplete="off"
          aria-label="Recherche de commandes"
          aria-autocomplete="list"
          aria-controls="command-list"
          [attr.aria-activedescendant]="'command-item-' + selectedIndex"
        />
        <mat-spinner
          *ngIf="isSearching"
          diameter="18"
          class="search-spinner"
          aria-label="Recherche en cours">
        </mat-spinner>
        <div class="shortcut-badge">
          <kbd>Ctrl</kbd><span class="kbd-sep">+</span><kbd>K</kbd>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="command-list"
         *ngIf="filteredItems.length > 0"
         id="command-list"
         role="listbox">
      <ng-container *ngFor="let group of getGroupedItems()">
        <div class="command-category" role="presentation">
          <span class="category-label">{{ group.category }}</span>
          <span class="category-count">{{ group.items.length }}</span>
        </div>
        <div
          *ngFor="let item of group.items"
          class="command-item"
          [class.selected]="filteredItems.indexOf(item) === selectedIndex"
          [id]="'command-item-' + filteredItems.indexOf(item)"
          (click)="executeItem(item)"
          (keydown.enter)="executeItem(item)"
          (mouseenter)="selectItem(filteredItems.indexOf(item))"
          role="option"
          [attr.aria-selected]="filteredItems.indexOf(item) === selectedIndex"
          tabindex="-1"
        >
          <div class="command-content">
            <div class="command-icon-wrap">
              <mat-icon class="command-icon" aria-hidden="true">{{ getItemIcon(item) }}</mat-icon>
            </div>
            <div class="command-details">
              <!-- Label: with highlight segments if available, plain text otherwise -->
              <div class="command-label">
                <ng-container *ngIf="getHighlightSegments(item) as segs; else plainLabel">
                  <ng-container *ngFor="let seg of segs">
                    <mark class="highlight" *ngIf="seg.match">{{ seg.text }}</mark>
                    <span *ngIf="!seg.match">{{ seg.text }}</span>
                  </ng-container>
                </ng-container>
                <ng-template #plainLabel>{{ getItemLabel(item) }}</ng-template>
              </div>
              <div class="command-description" *ngIf="getItemDescription(item)">
                {{ getItemDescription(item) }}
              </div>
            </div>
            <div class="command-shortcut" *ngIf="getItemShortcut(item)" [attr.aria-label]="'Raccourci: ' + getItemShortcut(item)">
              <kbd>{{ getItemShortcut(item) }}</kbd>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Empty State -->
    <div class="command-empty" *ngIf="filteredItems.length === 0 && !isSearching" role="status" aria-live="polite">
      <mat-icon aria-hidden="true">manage_search</mat-icon>
      <p *ngIf="searchQuery">Aucun résultat pour <strong>"{{ searchQuery }}"</strong></p>
      <p *ngIf="!searchQuery">Commencez à taper pour rechercher...</p>
      <p class="empty-hint" *ngIf="searchQuery">
        Essayez : <em>"prosp"</em>, <em>"facture"</em>, <em>"rdv"</em>
      </p>
    </div>

    <!-- Loading State -->
    <div class="command-loading" *ngIf="isSearching && searchQuery.length >= 2" role="status" aria-live="polite">
      <mat-spinner diameter="32" aria-label="Recherche en cours"></mat-spinner>
      <p>Recherche en cours dans la base...</p>
    </div>

    <!-- Footer -->
    <div class="command-footer">
      <div class="footer-shortcuts">
        <span class="footer-shortcut">
          <kbd>↑</kbd><kbd>↓</kbd> naviguer
        </span>
        <span class="footer-shortcut">
          <kbd>↵</kbd> sélectionner
        </span>
        <span class="footer-shortcut">
          <kbd>Esc</kbd> fermer
        </span>
      </div>
    </div>
  </div>
</div>
