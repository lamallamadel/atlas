<div class="report-builder-container">
  <mat-card class="builder-card">
    <mat-card-header>
      <mat-card-title>Custom Report Builder</mat-card-title>
      <mat-card-subtitle>Drag and drop dimensions and metrics to create your custom report</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="builder-grid">
        <div class="available-section">
          <h3>Available Dimensions</h3>
          <div 
            cdkDropList
            #dimensionsList="cdkDropList"
            [cdkDropListData]="availableDimensions"
            [cdkDropListConnectedTo]="[selectedDimensionsList]"
            (cdkDropListDropped)="dropDimension($event)"
            class="drop-zone">
            <div 
              class="drag-item" 
              *ngFor="let dimension of availableDimensions"
              cdkDrag>
              <mat-icon>drag_indicator</mat-icon>
              <div class="item-content">
                <strong>{{ dimension.label }}</strong>
                <small>{{ dimension.description }}</small>
              </div>
            </div>
            <div *ngIf="availableDimensions.length === 0" class="empty-message">
              All dimensions are in use
            </div>
          </div>

          <h3 class="mt-4">Available Metrics</h3>
          <div 
            cdkDropList
            #metricsList="cdkDropList"
            [cdkDropListData]="availableMetrics"
            [cdkDropListConnectedTo]="[selectedMetricsList]"
            (cdkDropListDropped)="dropMetric($event)"
            class="drop-zone">
            <div 
              class="drag-item" 
              *ngFor="let metric of availableMetrics"
              cdkDrag>
              <mat-icon>drag_indicator</mat-icon>
              <div class="item-content">
                <strong>{{ metric.label }}</strong>
                <small>{{ metric.description }} ({{ metric.aggregation }})</small>
              </div>
            </div>
            <div *ngIf="availableMetrics.length === 0" class="empty-message">
              All metrics are in use
            </div>
          </div>
        </div>

        <div class="selected-section">
          <h3>Selected Dimensions</h3>
          <div 
            cdkDropList
            #selectedDimensionsList="cdkDropList"
            [cdkDropListData]="selectedDimensions"
            [cdkDropListConnectedTo]="[dimensionsList]"
            (cdkDropListDropped)="dropDimension($event)"
            class="drop-zone selected-zone">
            <div 
              class="drag-item selected-item" 
              *ngFor="let dimension of selectedDimensions"
              cdkDrag>
              <mat-icon>drag_indicator</mat-icon>
              <div class="item-content">
                <strong>{{ dimension.label }}</strong>
              </div>
              <button mat-icon-button (click)="removeDimension(dimension)" color="warn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div *ngIf="selectedDimensions.length === 0" class="empty-message">
              Drag dimensions here
            </div>
          </div>

          <h3 class="mt-4">Selected Metrics</h3>
          <div 
            cdkDropList
            #selectedMetricsList="cdkDropList"
            [cdkDropListData]="selectedMetrics"
            [cdkDropListConnectedTo]="[metricsList]"
            (cdkDropListDropped)="dropMetric($event)"
            class="drop-zone selected-zone">
            <div 
              class="drag-item selected-item" 
              *ngFor="let metric of selectedMetrics"
              cdkDrag>
              <mat-icon>drag_indicator</mat-icon>
              <div class="item-content">
                <strong>{{ metric.label }}</strong>
              </div>
              <button mat-icon-button (click)="removeMetric(metric)" color="warn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div *ngIf="selectedMetrics.length === 0" class="empty-message">
              Drag metrics here
            </div>
          </div>
        </div>
      </div>

      <div class="actions-section" *ngIf="!reportGenerated">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="generateReport()"
          [disabled]="loading || selectedDimensions.length === 0 || selectedMetrics.length === 0">
          <mat-icon>assessment</mat-icon>
          Generate Report
        </button>
        <button mat-button (click)="resetReport()">
          <mat-icon>refresh</mat-icon>
          Reset
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="results-card" *ngIf="reportGenerated">
    <mat-card-header>
      <mat-card-title>Report Results</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="export-controls">
        <mat-form-field appearance="outline">
          <mat-label>Report Title</mat-label>
          <input matInput [(ngModel)]="reportTitle">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Subtitle (Optional)</mat-label>
          <input matInput [(ngModel)]="reportSubtitle">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Export Format</mat-label>
          <mat-select [(ngModel)]="exportFormat">
            <mat-option value="pdf">PDF</mat-option>
            <mat-option value="csv">CSV</mat-option>
            <mat-option value="excel">Excel</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="accent" (click)="exportReport()">
          <mat-icon>download</mat-icon>
          Export Report
        </button>
        <button mat-button (click)="resetReport()">
          <mat-icon>edit</mat-icon>
          Create New Report
        </button>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="reportData" class="report-table">
          <ng-container *ngFor="let dimension of selectedDimensions" [matColumnDef]="dimension.id">
            <th mat-header-cell *matHeaderCellDef>{{ dimension.label }}</th>
            <td mat-cell *matCellDef="let row">{{ row[dimension.id] }}</td>
          </ng-container>

          <ng-container *ngFor="let metric of selectedMetrics" [matColumnDef]="metric.id">
            <th mat-header-cell *matHeaderCellDef>{{ metric.label }}</th>
            <td mat-cell *matCellDef="let row">
              <span *ngIf="metric.id.includes('Rate')">{{ (row[metric.id] * 100).toFixed(2) }}%</span>
              <span *ngIf="metric.id.includes('Value')">{{ row[metric.id] | currency:'EUR':'symbol':'1.0-0' }}</span>
              <span *ngIf="!metric.id.includes('Rate') && !metric.id.includes('Value')">{{ row[metric.id] | number:'1.0-2' }}</span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
          <tr mat-row *matRowDef="let row; columns: getDisplayedColumns()"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner></mat-spinner>
  </div>
</div>
