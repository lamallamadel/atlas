<div class="activity-timeline-container">
  <div class="timeline-header">
    <h3>Chronologie d'activité</h3>
    <button mat-raised-button color="primary" (click)="openNoteDialog()">
      <mat-icon>add</mat-icon>
      Ajouter une note
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des activités...</p>
  </div>

  <div *ngIf="!loading && activities.length === 0" class="no-activities">
    <mat-icon>timeline</mat-icon>
    <p>Aucune activité pour le moment</p>
  </div>

  <div *ngIf="!loading && activities.length > 0" class="timeline">
    <div *ngFor="let activity of activities; trackBy: trackByActivityId" class="timeline-item">
      <div class="timeline-marker">
        <mat-icon [class]="getActivityTypeBadgeClass(activity.type)">
          {{ getActivityTypeIcon(activity.type) }}
        </mat-icon>
      </div>
      
      <mat-card class="activity-card">
        <mat-card-header>
          <div class="avatar-container" mat-card-avatar>
            <div class="user-avatar">
              {{ getUserInitials(activity.createdByName || activity.createdBy) }}
            </div>
          </div>
          <div class="activity-header-content">
            <div class="activity-header-top">
              <div class="activity-title-row">
                <span class="activity-type">{{ getActivityTypeLabel(activity.type) }}</span>
                <span [class]="getVisibilityBadgeClass(activity.visibility)">
                  <mat-icon class="badge-icon">{{ getVisibilityIcon(activity.visibility) }}</mat-icon>
                  {{ getVisibilityLabel(activity.visibility) }}
                </span>
              </div>
              <button 
                mat-icon-button 
                *ngIf="activity.type === ActivityType.NOTE"
                [matMenuTriggerFor]="actionsMenu"
                class="actions-menu-button"
                (click)="$event.stopPropagation()">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item (click)="editActivity(activity)">
                  <mat-icon>edit</mat-icon>
                  <span>Modifier</span>
                </button>
                <button mat-menu-item (click)="deleteActivity(activity)">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>Supprimer</span>
                </button>
              </mat-menu>
            </div>
            <div class="activity-meta">
              <span class="activity-author">{{ activity.createdByName || activity.createdBy }}</span>
              <span class="meta-separator">•</span>
              <span class="activity-time">{{ formatDateTime(activity.createdAt) }}</span>
            </div>
          </div>
        </mat-card-header>

        <mat-card-content>
          <div class="activity-content" *ngIf="activity.content">
            <div *ngIf="!isExpanded(activity.id) && shouldShowExpand(activity.content)" 
                 [innerHTML]="sanitizeContent(truncateContent(activity.content))"></div>
            <div *ngIf="isExpanded(activity.id) || !shouldShowExpand(activity.content)" 
                 [innerHTML]="sanitizeContent(activity.content)"></div>
            
            <button *ngIf="shouldShowExpand(activity.content)" 
                    mat-button 
                    color="primary" 
                    (click)="toggleExpanded(activity.id)"
                    class="expand-button">
              <mat-icon>{{ isExpanded(activity.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
              {{ isExpanded(activity.id) ? 'Voir moins' : 'Voir plus' }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
