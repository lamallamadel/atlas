<div class="search-container" role="search">
  <label for="global-search-input" class="sr-only">Rechercher des annonces, dossiers et contacts</label>
  
  <div class="search-input-wrapper">
    <input
      id="global-search-input"
      #searchInput
      type="text"
      class="search-input"
      placeholder="Rechercher... (Appuyez sur / pour focus)"
      [(ngModel)]="searchQuery"
      (input)="onSearchInput($event)"
      (focus)="onFocus()"
      (blur)="onBlur()"
      aria-label="Rechercher des annonces, dossiers et contacts"
      aria-autocomplete="list"
      [attr.aria-expanded]="showDropdown && (hasResults || isLoading || error || showRecentSearches)"
      [attr.aria-controls]="showDropdown ? 'search-results' : null"
    />
    <span class="search-icon" aria-hidden="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    </span>
    <button 
      *ngIf="searchQuery" 
      class="clear-button" 
      (click)="clearSearch()" 
      aria-label="Effacer la recherche" 
      type="button"
      tabindex="-1">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div id="search-results" 
       class="search-dropdown" 
       *ngIf="showDropdown && (hasResults || isLoading || error || showRecentSearches)"
       role="listbox"
       [attr.aria-label]="'Résultats de recherche'">
    
    <!-- Loading State -->
    <div class="loading" *ngIf="isLoading" role="status" aria-live="polite">
      <div class="spinner"></div>
      <span>Recherche en cours...</span>
    </div>
    
    <!-- Error State -->
    <div class="error" *ngIf="error && !isLoading" role="alert" aria-live="assertive">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>{{ error }}</span>
    </div>

    <!-- Recent Searches -->
    <div class="recent-searches" *ngIf="showRecentSearches && !isLoading" role="group">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span>Recherches récentes</span>
      </div>
      <div class="recent-search-list">
        <div 
          *ngFor="let search of recentSearches"
          class="recent-search-item"
          (mousedown)="selectRecentSearch(search)"
          role="button"
          tabindex="0">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <span class="recent-search-query">{{ search.query }}</span>
          <button 
            class="remove-recent-btn" 
            (mousedown)="removeRecentSearch(search, $event)"
            aria-label="Supprimer cette recherche"
            type="button"
            tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Search Results -->
    <div class="results" *ngIf="!isLoading && !error && hasResults" role="group">
      
      <!-- Annonces Group -->
      <div class="result-group" *ngIf="groupedResults.annonces.length > 0">
        <div class="group-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span>Annonces ({{ groupedResults.annonces.length }})</span>
        </div>
        <div
          *ngFor="let result of groupedResults.annonces; let i = index"
          [attr.id]="'search-result-' + getResultIndex('annonces', i)"
          class="result-item"
          [class.selected]="isSelected(getResultIndex('annonces', i))"
          (mousedown)="navigateToResult(result)"
          (mouseenter)="onResultHover(result)"
          (mouseleave)="onResultLeave()"
          role="option"
          tabindex="-1"
          [attr.aria-label]="result.type + ': ' + result.title"
          [attr.aria-selected]="isSelected(getResultIndex('annonces', i))">
          <div class="result-icon annonce">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-title" [innerHTML]="result.highlightedTitle"></div>
            <div class="result-description" *ngIf="result.highlightedDescription" [innerHTML]="result.highlightedDescription"></div>
          </div>
          <div class="result-meta">
            <span class="result-badge annonce">Annonce</span>
          </div>
        </div>
      </div>

      <!-- Dossiers Group -->
      <div class="result-group" *ngIf="groupedResults.dossiers.length > 0">
        <div class="group-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>Dossiers ({{ groupedResults.dossiers.length }})</span>
        </div>
        <div
          *ngFor="let result of groupedResults.dossiers; let i = index"
          [attr.id]="'search-result-' + getResultIndex('dossiers', i)"
          class="result-item"
          [class.selected]="isSelected(getResultIndex('dossiers', i))"
          (mousedown)="navigateToResult(result)"
          (mouseenter)="onResultHover(result)"
          (mouseleave)="onResultLeave()"
          role="option"
          tabindex="-1"
          [attr.aria-label]="result.type + ': ' + result.title"
          [attr.aria-selected]="isSelected(getResultIndex('dossiers', i))">
          <div class="result-icon dossier">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-title" [innerHTML]="result.highlightedTitle"></div>
            <div class="result-description" *ngIf="result.highlightedDescription" [innerHTML]="result.highlightedDescription"></div>
          </div>
          <div class="result-meta">
            <span class="result-badge dossier">Dossier</span>
          </div>
        </div>
      </div>

      <!-- Contacts Group -->
      <div class="result-group" *ngIf="groupedResults.contacts.length > 0">
        <div class="group-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          <span>Contacts ({{ groupedResults.contacts.length }})</span>
        </div>
        <div
          *ngFor="let result of groupedResults.contacts; let i = index"
          [attr.id]="'search-result-' + getResultIndex('contacts', i)"
          class="result-item"
          [class.selected]="isSelected(getResultIndex('contacts', i))"
          (mousedown)="navigateToResult(result)"
          (mouseenter)="onResultHover(result)"
          (mouseleave)="onResultLeave()"
          role="option"
          tabindex="-1"
          [attr.aria-label]="result.type + ': ' + result.title"
          [attr.aria-selected]="isSelected(getResultIndex('contacts', i))">
          <div class="result-icon contact">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="result-content">
            <div class="result-title" [innerHTML]="result.highlightedTitle"></div>
            <div class="result-description" *ngIf="result.highlightedDescription" [innerHTML]="result.highlightedDescription"></div>
          </div>
          <div class="result-meta">
            <span class="result-badge contact">Contact</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- No Results State -->
    <div class="no-results" *ngIf="!isLoading && !error && !hasResults && searchQuery && !showRecentSearches" role="status" aria-live="polite">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <span class="no-results-text">Aucun résultat trouvé</span>
      <span class="no-results-hint">Essayez d'autres mots-clés</span>
    </div>
    
    <!-- Footer -->
    <div class="search-footer" *ngIf="!isLoading && hasResults">
      <div class="footer-left">
        <button 
          class="view-all-button" 
          (mousedown)="viewAllResults()"
          type="button"
          tabindex="-1"
          [attr.aria-label]="'Voir tous les résultats de recherche (' + totalHits + ' résultats)'">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
          Voir tous les résultats ({{ totalHits }})
        </button>
      </div>
      <div class="footer-right">
        <div class="keyboard-hints">
          <span class="hint">
            <kbd>↑</kbd><kbd>↓</kbd> Navigation
          </span>
          <span class="hint">
            <kbd>↵</kbd> Sélectionner
          </span>
          <span class="hint">
            <kbd>Esc</kbd> Fermer
          </span>
        </div>
        <span 
          class="es-status" 
          *ngIf="!elasticsearchAvailable" 
          title="Utilisation de la recherche PostgreSQL" 
          aria-label="Utilisation de la recherche PostgreSQL">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </span>
      </div>
    </div>

    <!-- Hover Preview Panel -->
    <div class="preview-panel" *ngIf="hoveredResult && hoveredResult.preview">
      <div class="preview-header">
        <span class="preview-type-badge" [class]="hoveredResult.type">
          {{ hoveredResult.type | uppercase }}
        </span>
        <span class="preview-id">#{{ hoveredResult.id }}</span>
      </div>
      <div class="preview-title">{{ hoveredResult.title }}</div>
      <div class="preview-details">
        <div class="preview-detail" *ngFor="let detail of hoveredResult.preview.details">
          <span class="detail-label">{{ detail.label }}:</span>
          <span class="detail-value">{{ detail.value }}</span>
        </div>
      </div>
      <div class="preview-footer">
        <span class="preview-hint">Cliquez pour ouvrir</span>
      </div>
    </div>
  </div>
</div>
