# Native Mobile App Development Guide

## Overview

This Angular PWA has been enhanced with Capacitor to create native iOS and Android mobile applications. The app wraps the existing Angular PWA and provides access to native device features.

## Architecture

### Hybrid Approach
- **Web Layer**: Angular 16 PWA with service workers for offline support
- **Native Bridge**: Capacitor 5 provides JavaScript-to-native communication
- **Native Layer**: iOS (Swift/Objective-C) and Android (Java/Kotlin) platforms

### Native Features Implemented

1. **Biometric Authentication** (`@capacitor/biometric`)
   - Face ID (iOS)
   - Touch ID (iOS)
   - Fingerprint (Android)
   - Fallback to device passcode

2. **Calendar Synchronization** (`@capacitor/calendar`)
   - Create appointments
   - Update events
   - Delete events
   - Sync visits to native calendar

3. **Push Notifications** (`@capacitor/push-notifications`)
   - APNs (iOS)
   - FCM (Android)
   - Notification channels (Android)
   - Deep linking from notifications

4. **File System Access** (`@capacitor/filesystem`)
   - Offline document storage
   - Image caching
   - File management
   - Storage optimization

5. **Platform Services**
   - Network status monitoring
   - App state management
   - Device information
   - Status bar control
   - Splash screen
   - Haptic feedback
   - Screen reader support
   - Share functionality

## Project Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── services/
│   │   │   ├── native-biometric.service.ts
│   │   │   ├── native-calendar.service.ts
│   │   │   ├── native-push-notifications.service.ts
│   │   │   ├── native-filesystem.service.ts
│   │   │   ├── native-platform.service.ts
│   │   │   └── native-app-init.service.ts
│   │   └── directives/
│   │       └── mobile-gestures.directive.ts
│   └── styles/
│       └── mobile-optimizations.scss
├── capacitor.config.ts
├── capacitor-assets.config.json
├── android/                      # Generated by Capacitor
├── ios/                          # Generated by Capacitor
├── resources/                    # Source assets for icons/splash
└── CAPACITOR_SETUP.md           # Detailed setup guide
```

## Services

### NativeBiometricService

Handles biometric authentication across platforms.

```typescript
import { NativeBiometricService } from '@app/services/native-biometric.service';

// Check availability
this.biometricService.checkBiometricAvailability().subscribe(result => {
  if (result.available) {
    // Biometrics available
  }
});

// Authenticate
this.biometricService.authenticate('Authenticate to continue').subscribe(result => {
  if (result.success) {
    // Authentication successful
  }
});
```

### NativeCalendarService

Manages calendar synchronization.

```typescript
import { NativeCalendarService } from '@app/services/native-calendar.service';

// Request permissions
this.calendarService.requestPermissions().subscribe(result => {
  if (result.granted) {
    // Create event
    this.calendarService.createEvent({
      title: 'Property Visit',
      startDate: new Date(),
      endDate: new Date(Date.now() + 3600000),
      location: '123 Main St',
      notes: 'Client meeting'
    }).subscribe(result => {
      if (result.success) {
        console.log('Event created:', result.eventId);
      }
    });
  }
});
```

### NativePushNotificationsService

Handles push notifications.

```typescript
import { NativePushNotificationsService } from '@app/services/native-push-notifications.service';

// Initialize (done automatically in app.component)
// Subscribe to notification events
this.pushService.notificationReceived$.subscribe(notification => {
  // Handle foreground notification
});

this.pushService.notificationAction$.subscribe(action => {
  // Handle notification tap
  const route = this.pushService.handleNotificationAction(action);
  this.router.navigate([route.route]);
});

// Get push token
const token = this.pushService.getToken();
```

### NativeFilesystemService

Manages local file storage.

```typescript
import { NativeFilesystemService } from '@app/services/native-filesystem.service';

// Save document offline
this.filesystemService.saveDocumentOffline(
  documentId,
  content,
  filename
).subscribe(result => {
  if (result.success) {
    console.log('Saved to:', result.path);
  }
});

// Load offline document
this.filesystemService.getOfflineDocument(
  documentId,
  filename
).subscribe(content => {
  // Use content
});

// Cache image
this.filesystemService.cacheImage(imageUrl, blob).subscribe(result => {
  if (result.success) {
    // Image cached
  }
});
```

### NativePlatformService

Provides platform utilities.

```typescript
import { NativePlatformService } from '@app/services/native-platform.service';

// Check platform
if (this.platformService.isIOS()) {
  // iOS-specific code
}

// Network status
this.platformService.networkStatus$.subscribe(status => {
  if (!status.connected) {
    // Device offline
  }
});

// App state
this.platformService.appState$.subscribe(state => {
  if (state.isActive) {
    // App in foreground
  }
});

// Haptic feedback
this.platformService.hapticImpact('Medium').subscribe();
this.platformService.hapticNotification('SUCCESS').subscribe();

// Share content
this.platformService.share({
  title: 'Check this out',
  text: 'Great property!',
  url: 'https://example.com'
}).subscribe();
```

## Mobile Gestures Directive

Optimized touch interactions for mobile devices.

```html
<div
  appMobileGestures
  (swipeLeft)="onSwipeLeft($event)"
  (swipeRight)="onSwipeRight($event)"
  (swipeUp)="onSwipeUp($event)"
  (swipeDown)="onSwipeDown($event)"
  (longPress)="onLongPress($event)"
  (doubleTap)="onDoubleTap($event)"
  (pinch)="onPinch($event)"
  [swipeThreshold]="50"
  [longPressDelay]="500"
  [enableHaptics]="true">
  <!-- Content -->
</div>
```

```typescript
onSwipeLeft(event: SwipeEvent) {
  console.log('Swiped left:', event.distance, event.velocity);
  // Navigate to next item
}

onLongPress(event: TouchEvent) {
  // Show context menu
}

onDoubleTap(event: TouchEvent) {
  // Zoom in
}
```

## Mobile Styles

The app includes mobile-optimized styles in `mobile-optimizations.scss`:

### Safe Area Support

```html
<div class="safe-area-all">
  <!-- Content respects notch areas -->
</div>
```

### Touch-Optimized Buttons

```html
<button class="btn-touch">Large Touch Target</button>
```

### Native-Style Header

```html
<header class="native-header">
  <button class="back-button">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h1 class="title">Page Title</h1>
</header>
```

### Bottom Navigation

```html
<nav class="bottom-nav">
  <a class="nav-item active" routerLink="/dashboard">
    <mat-icon class="icon">home</mat-icon>
    <span>Accueil</span>
  </a>
  <!-- More nav items -->
</nav>
```

### Floating Action Button

```html
<button class="fab" (click)="onAddClick()">
  <mat-icon class="icon">add</mat-icon>
</button>
```

### Bottom Sheet

```html
<div class="mobile-backdrop" [class.visible]="isSheetVisible"></div>
<div class="bottom-sheet" [class.visible]="isSheetVisible">
  <div class="handle"></div>
  <!-- Sheet content -->
</div>
```

## Deep Linking

### WhatsApp Callback

The app handles WhatsApp OAuth callbacks via deep links:

**URL Scheme**: `atlasimmo://whatsapp/callback?code=XXX&state=YYY`

```typescript
// Handled automatically by NativePlatformService
// Listen for callback in component:
window.addEventListener('whatsapp-callback', (event: any) => {
  const { code, state } = event.detail;
  // Process OAuth callback
});
```

### Custom Deep Links

```typescript
// Navigate to dossier: atlasimmo://dossiers/{id}
// Handled automatically by NativePlatformService
```

## Development Workflow

### 1. Web Development

```bash
cd frontend
npm start
# Develop as usual at http://localhost:4200
```

### 2. Build for Mobile

```bash
npm run build:mobile
# Or separately:
npm run build:prod
npm run cap:sync
```

### 3. iOS Development

```bash
npm run cap:open:ios
# Opens Xcode - click Run
```

### 4. Android Development

```bash
npm run cap:open:android
# Opens Android Studio - click Run
```

### 5. Live Reload (Development)

```bash
# Terminal 1: Start Angular dev server
npm start

# Terminal 2: Update capacitor.config.ts with your local IP
# Then sync
npm run cap:sync

# Run on device - app will load from dev server
```

## Performance Optimizations

### 1. GPU Acceleration

```html
<div class="gpu-accelerated">
  <!-- Hardware-accelerated animations -->
</div>
```

### 2. Optimized Scrolling

```html
<div class="mobile-scroll optimized-scroll">
  <!-- Smooth scrolling with containment -->
</div>
```

### 3. Image Optimization

- Use WebP format where possible
- Implement lazy loading
- Cache images in native filesystem
- Use appropriate image sizes for device

### 4. Bundle Optimization

- Code splitting (already configured)
- Tree shaking (already configured)
- Lazy-loaded routes
- Service worker caching

## Testing

### Device Testing

**iOS Simulator**:
```bash
npm run cap:open:ios
# Select simulator and run
```

**Android Emulator**:
```bash
npm run cap:open:android
# Select emulator and run
```

**Physical Devices**:
- iOS: Connect via USB, select device in Xcode
- Android: Enable USB debugging, select device in Android Studio

### E2E Testing

The existing Playwright tests work on web. For mobile-specific testing:

```bash
# Run on iOS simulator
npm run e2e -- --project=ios

# Run on Android emulator
npm run e2e -- --project=android
```

## CI/CD

### GitHub Actions Workflows

1. **iOS Build & Deploy** (`.github/workflows/mobile-ios-ci.yml`)
   - Builds iOS app
   - Deploys to TestFlight
   - Requires Apple Developer secrets

2. **Android Build & Deploy** (`.github/workflows/mobile-android-ci.yml`)
   - Builds Android app
   - Deploys to Google Play
   - Requires Google Play secrets

### Required Secrets

See `CAPACITOR_SETUP.md` for complete list of required secrets.

## Troubleshooting

### Common Issues

**1. Build Errors After Adding Capacitor**

```bash
# Clean and rebuild
rm -rf node_modules package-lock.json
npm install
npm run build:mobile
```

**2. iOS Pod Install Fails**

```bash
cd ios/App
pod deintegrate
pod install --repo-update
```

**3. Android Gradle Errors**

```bash
cd android
./gradlew clean
./gradlew build
```

**4. Deep Links Not Working**

- Verify URL schemes in Info.plist (iOS)
- Verify intent filters in AndroidManifest.xml (Android)
- Test with Terminal/ADB:
  ```bash
  # iOS
  xcrun simctl openurl booted "atlasimmo://test"
  
  # Android
  adb shell am start -W -a android.intent.action.VIEW -d "atlasimmo://test"
  ```

**5. Push Notifications Not Received**

- iOS: Verify APNs certificates and provisioning profile
- Android: Verify google-services.json is in place
- Check device permissions
- Test with Firebase Console test message

## Best Practices

### 1. Platform Detection

Always check if running on native platform:

```typescript
import { Capacitor } from '@capacitor/core';

if (Capacitor.isNativePlatform()) {
  // Use native feature
} else {
  // Use web fallback
}
```

### 2. Permission Requests

Request permissions with context:

```typescript
// Bad - no context
this.calendarService.requestPermissions();

// Good - explain why
showPermissionDialog().then(() => {
  this.calendarService.requestPermissions();
});
```

### 3. Offline Support

Always handle offline scenarios:

```typescript
this.platformService.networkStatus$.subscribe(status => {
  if (!status.connected) {
    this.showOfflineMode();
    this.filesystemService.loadOfflineData();
  }
});
```

### 4. Performance

- Use virtual scrolling for long lists
- Lazy load images
- Debounce user input
- Use OnPush change detection
- Minimize re-renders

### 5. Accessibility

- Maintain WCAG AA compliance
- Test with VoiceOver (iOS) and TalkBack (Android)
- Ensure minimum touch target size (44x44px iOS, 48x48px Android)

## Resources

- [Capacitor Documentation](https://capacitorjs.com/docs)
- [iOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)
- [Material Design for Android](https://material.io/design)
- [App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/)
- [Google Play Policy Center](https://play.google.com/about/developer-content-policy/)

## Support

For issues or questions:
1. Check `CAPACITOR_SETUP.md` for detailed setup instructions
2. Review troubleshooting section above
3. Check Capacitor documentation
4. Contact development team
